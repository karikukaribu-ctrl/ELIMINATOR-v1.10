<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ELIMINATOR</title>
  <style>
    :root{
      --bg:#0b0d12;
      --fg:#e9edf5;
      --muted:#a8b0bd;

      --panel:#121625;
      --panel2:#0d1020;

      --line:rgba(255,255,255,0.10);
      --soft:rgba(255,255,255,0.06);

      --chip:rgba(0,0,0,0.18);

      --accent1:#f2f2f2;
      --accent2:#aeb7c7;

      --shadow:0 18px 60px rgba(0,0,0,0.62);
      --r:24px;

      --ok: rgba(242,242,242,0.92);
      --warn: rgba(255,255,255,0.84);
      --boom: rgba(255,255,255,0.14);

      --glass: blur(10px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(242,242,242,0.10), transparent 62%),
        radial-gradient(900px 420px at 20% 20%, rgba(242,242,242,0.07), transparent 60%),
        linear-gradient(180deg, #07080c, var(--bg));
      color: var(--fg);
      overflow-x:hidden;
    }

    /* ====== FX Canvas ====== */
    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 110;
    }

    /* ====== App Shell ====== */
    .shell{
      min-height:100vh;
      display:grid;
      grid-template-rows: auto 1fr auto;
    }

    /* ====== Top minimal bar ====== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      gap:10px;
    }
    .topbar.hidden{ display:none; }

    .topbar .left, .topbar .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .iconbtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.12);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:0.08em;
      text-transform: uppercase;
      font-size: 12px;
      user-select:none;
    }
    .iconbtn:hover{ border-color: rgba(242,242,242,0.22); }
    .iconbtn:active{ transform: translateY(1px); }
    .iconbtn:disabled{ opacity:0.5; cursor:not-allowed; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.12);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      user-select:none;
      white-space:nowrap;
    }
    .chip b{ color: var(--fg); font-weight: 1000; }

    /* ====== Stage ====== */
    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px 22px;
    }

    .focusCard{
      width: min(1040px, 96vw);
      border-radius: var(--r);
      border: 1px solid rgba(242,242,242,0.10);
      background:
        radial-gradient(980px 460px at 50% 0%, rgba(242,242,242,0.13), transparent 62%),
        linear-gradient(180deg, rgba(18,22,37,0.86), rgba(10,12,22,0.86));
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      padding: 18px;
      display:grid;
      gap: 14px;
      position:relative;
      overflow:hidden;
    }

    /* Brand */
    .brand{
      text-align:center;
      display:grid;
      gap: 6px;
      margin-top: 2px;
    }
    .brand h1{
      margin:0;
      font-size: clamp(34px, 6vw, 64px);
      font-weight: 1100;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      line-height:1;
      text-shadow: 0 12px 40px rgba(0,0,0,0.55);
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      letter-spacing:0.16em;
      text-transform: uppercase;
    }

    /* Floating surprise line (above actions) */
    .floatLine{
      text-align:center;
      min-height: 18px;
      color: rgba(242,242,242,0.86);
      font-weight: 900;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      opacity: 0.92;
      user-select:none;
    }

    /* Big global bar (NO % label visible) */
    .barWrap{
      border-radius: 999px;
      height: 26px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .barFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 240ms ease;
    }
    .barLabel{ display:none; } /* demandé: pas de % visible */

    /* Focus task area */
    .target{
      display:grid;
      gap: 10px;
      text-align:center;
      align-items:center;
    }
    .targetTitle{
      font-size: clamp(20px, 3.4vw, 30px);
      font-weight: 1000;
      line-height:1.15;
      word-break: break-word;
      padding: 0 6px;
    }
    .targetMeta{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:0.04em;
      line-height:1.2;
    }

    /* Small task bar (NO % label visible) */
    .sbarWrap{
      border-radius: 999px;
      height: 12px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
      max-width: min(760px, 92vw);
      margin: 0 auto;
    }
    .sbarFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(242,242,242,0.82), rgba(174,183,199,0.70));
      transition: width 200ms ease;
    }
    .sbarLabel{ display:none; } /* demandé: pas de % visible */

    /* ====== Actions: roulette + BIG central dego ====== */
    .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 16px;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    /* Roulette big, casino vibe */
    .btnRoulette{
      width: 108px;
      height: 108px;
      border-radius: 999px;
      border:1px solid rgba(242,242,242,0.22);
      background:
        radial-gradient(closest-side, rgba(242,242,242,0.22), rgba(0,0,0,0.06)),
        linear-gradient(180deg, #0b0d12, #070810);
      color: var(--fg);
      cursor:pointer;
      font-weight: 1100;
      letter-spacing:0.12em;
      text-transform: uppercase;
      display:grid;
      place-items:center;
      user-select:none;
      position:relative;
      box-shadow: 0 14px 40px rgba(0,0,0,0.50);
    }
    .btnRoulette .ring{
      position:absolute; inset:12px;
      border-radius: 999px;
      border:2px dashed rgba(255,255,255,0.18);
      opacity:0.80;
    }
    .btnRoulette .inner{
      position:absolute; inset:26px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.10);
      opacity:0.85;
    }
    .btnRoulette:hover{ border-color: rgba(242,242,242,0.36); }
    .btnRoulette:active{ transform: translateY(1px); }
    .btnRoulette:disabled{ opacity:0.5; cursor:not-allowed; }
    .btnRoulette.spinning .ring{ animation: spin 520ms linear infinite; }
    .btnRoulette.spinning .inner{ animation: spin2 860ms linear infinite; }
    @keyframes spin{ from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }
    @keyframes spin2{ from{ transform: rotate(360deg);} to{ transform: rotate(0deg);} }

    /* Big central dego button */
    .btnDego{
      border:1px solid rgba(242,242,242,0.18);
      background:
        radial-gradient(900px 260px at 50% 20%, rgba(242,242,242,0.12), transparent 62%),
        linear-gradient(180deg, #0b0d12, #070810);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color:var(--fg);
      border-radius: 20px;
      padding: 18px 20px;
      cursor:pointer;
      font-weight: 1100;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      min-height: 70px;
      min-width: min(660px, 86vw);
      box-shadow: 0 14px 40px rgba(0,0,0,0.45);
      position:relative;
      overflow:hidden;
    }
    .btnDego::after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(520px 120px at 50% 30%, rgba(242,242,242,0.10), transparent 60%);
      opacity:0.75;
      pointer-events:none;
      transition: opacity 180ms ease;
    }
    .btnDego:hover{ border-color: rgba(242,242,242,0.32); }
    .btnDego:hover::after{ opacity:1; }
    .btnDego:active{ transform: translateY(1px); }
    .btnDego:disabled{ opacity:0.5; cursor:not-allowed; }

    .subActions{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 2px;
    }

    .btn{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:0.08em;
      text-transform: uppercase;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(255,255,255,0.18); }
    .btn:active{ transform: translateY(1px); }

    /* Footer hint */
    .hint{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height:1.25;
      padding: 10px 14px 18px;
      opacity:0.95;
    }
    .hint.hidden{ display:none; }

    /* ====== Drawer (menu translucide) ====== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.56);
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease;
      z-index: 90;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .drawer{
      position:fixed;
      top:0; left:0;
      height:100vh;
      width: min(620px, 94vw);
      background:
        radial-gradient(900px 420px at 40% 0%, rgba(242,242,242,0.14), transparent 62%),
        linear-gradient(180deg, rgba(18,22,37,0.90), rgba(10,12,22,0.90));
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      border-right: 1px solid rgba(255,255,255,0.10);
      transform: translateX(-110%);
      transition: transform 180ms ease;
      z-index: 100;
      display:grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
      touch-action: pan-y;
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .drawerHeader .h{
      font-weight: 1000;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      color: var(--fg);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:0.08em;
      text-transform: uppercase;
      user-select:none;
    }
    .tab.active{ border-color: rgba(242,242,242,0.26); }

    .drawerBody{
      overflow:auto;
      padding-right: 4px;
      display:grid;
      gap: 12px;
      align-content:start;
    }

    .card{
      border:1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      background: rgba(0,0,0,0.10);
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .cardTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-weight: 1000;
      letter-spacing:0.14em;
      text-transform: uppercase;
      font-size: 11px;
    }

    textarea, select, input[type="text"]{
      font:inherit;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{ width:100%; min-height: 140px; resize: vertical; line-height:1.35; }
    textarea:focus, select:focus, input:focus{ border-color: rgba(242,242,242,0.22); }

    .rowBtns{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Lists */
    .list{ display:grid; gap:8px; }

    .trow{
      border:1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      background: rgba(0,0,0,0.12);
      padding: 10px;
      display:grid;
      gap:8px;
    }

    .trowTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .tname{
      font-weight: 950;
      font-size: 14px;
      line-height:1.2;
      word-break: break-word;
    }
    .tmini{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      line-height:1.15;
    }
    .tacts{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .done{ text-decoration: line-through; opacity:0.55; }

    .sbarMiniWrap{
      border-radius: 999px;
      height: 10px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .sbarMiniFill{
      height:100%;
      background: linear-gradient(90deg, rgba(242,242,242,0.78), rgba(174,183,199,0.62));
      transition: width 180ms ease;
    }

    details{
      border:1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,0.10);
    }
    summary{
      cursor:pointer;
      padding: 10px 12px;
      color: var(--muted);
      font-weight: 1000;
      letter-spacing:0.14em;
      text-transform: uppercase;
      font-size: 11px;
      user-select:none;
    }
    details > .inside{
      padding: 10px 12px 12px;
      display:grid;
      gap:10px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(9,10,14,0.84);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--fg);
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease, transform 160ms ease;
      max-width: min(920px, calc(100vw - 24px));
      box-shadow: var(--shadow);
      white-space:pre-wrap;
      z-index: 120;
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* End overlay (big win) */
    .win{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      z-index: 130;
      background: rgba(0,0,0,0.60);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
    }
    .win.show{ display:grid; }
    .winCard{
      width: min(900px, 92vw);
      border-radius: 26px;
      border:1px solid rgba(242,242,242,0.12);
      background:
        radial-gradient(900px 420px at 50% 0%, rgba(242,242,242,0.16), transparent 62%),
        linear-gradient(180deg, rgba(18,22,37,0.92), rgba(10,12,22,0.92));
      box-shadow: var(--shadow);
      padding: 18px;
      text-align:center;
      display:grid;
      gap:10px;
    }
    .winTitle{
      font-weight: 1100;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-size: clamp(20px, 3.6vw, 34px);
    }
    .winText{
      color: rgba(242,242,242,0.86);
      font-weight: 800;
      letter-spacing: 0.06em;
      line-height: 1.35;
      font-size: 14px;
    }

    /* Responsive tweaks */
    @media (max-width: 520px){
      .btnDego{ min-width: 92vw; }
      .focusCard{ padding: 16px; }
      .btnRoulette{ width: 96px; height:96px; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="shell">
    <div class="topbar" id="topbar">
      <div class="left">
        <button class="iconbtn" id="btnMenu" aria-label="Menu">☰</button>
        <button class="iconbtn" id="btnNewDay">Nouveau jour</button>
      </div>

      <div class="right chips" aria-label="Compteurs">
        <span class="chip">Départ <b id="startTasks">0</b> tâches</span>
        <span class="chip">Reste <b id="leftTasks">0</b> tâches</span>
        <span class="chip">ETH <b id="leftEth">0</b>/<b id="startEth">0</b></span>
        <span class="chip">Éliminé <b id="elimEth">0</b></span>
      </div>
    </div>

    <div class="stage">
      <section class="focusCard" aria-label="Focus">
        <div class="brand">
          <h1>ELIMINATOR</h1>
          <p>Dégommez-les tous</p>
        </div>

        <!-- BIG GLOBAL BAR (remaining % but label hidden) -->
        <div class="barWrap" aria-label="Progression globale">
          <div class="barFill" id="gFill"></div>
          <div class="barLabel" id="gLabel">100%</div>
        </div>

        <div class="target" aria-label="Cible">
          <div class="targetTitle" id="focusTitle">CIBLE EN COURS DE RECHERCHE</div>
          <div class="targetMeta" id="focusMeta">—</div>

          <!-- Small task bar -->
          <div class="sbarWrap" aria-label="Progression tâche">
            <div class="sbarFill" id="tFill"></div>
            <div class="sbarLabel" id="tLabel">100%</div>
          </div>

          <!-- Floating line (above actions) -->
          <div class="floatLine" id="floatLine">—</div>

          <div class="actions">
            <button class="btnRoulette" id="btnRoulette" aria-label="Roulette">
              <span class="ring"></span>
              <span class="inner"></span>
              R
            </button>

            <button class="btnDego" id="btnDego">Dégommer 1 ethorion</button>
          </div>

          <div class="subActions">
            <button class="btn" id="btnNotesTask">Notes tâche</button>
            <button class="btn" id="btnNotesDay">Notes jour</button>
            <button class="btn" id="btnDone">Terminer</button>
            <button class="btn" id="btnSkip">Passer</button>
          </div>
        </div>
      </section>
    </div>

    <div class="hint" id="hint">
      Import : seules les lignes qui commencent par “-” sont ajoutées comme tâches. Le reste = catégories.
      Raccourci : Ctrl/⌘+Enter pour ajouter depuis Inbox. R = roulette · D = dégommage · M = menu.
    </div>
  </div>

  <!-- Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-label="Menu latéral">
    <div class="drawerHeader">
      <div class="h">Menu</div>
      <button class="btn" id="btnClose">Fermer</button>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="drawerBody" id="drawerBody"></div>

    <div class="rowBtns">
      <button class="btn" id="btnUndo">Undo</button>
      <button class="btn" id="btnRedo">Redo</button>
    </div>
  </aside>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- BIG END -->
  <div class="win" id="win">
    <div class="winCard">
      <div class="winTitle" id="winTitle">MISSION ACCOMPLIE</div>
      <div class="winText" id="winText">
        Plus rien à dégomm… c’est louche. Soit tu es un ninja suprême, soit l’univers a crashé.
      </div>
      <div class="rowBtns" style="justify-content:center;">
        <button class="btn" id="btnWinClose">Retour</button>
        <button class="btn" id="btnWinNewDay">Nouveau jour</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // =========================
  // Storage + State
  // =========================
  const LS_KEY = "eliminator_app_v2";
  const MAX_HISTORY = 50;

  const el = (id)=>document.getElementById(id);
  const now = ()=>Date.now();
  const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
  const uid = ()=> Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36);

  // Top counters
  const startTasksEl = el("startTasks");
  const leftTasksEl  = el("leftTasks");
  const startEthEl   = el("startEth");
  const leftEthEl    = el("leftEth");
  const elimEthEl    = el("elimEth");

  // Bars
  const gFill = el("gFill");
  const gLabel = el("gLabel");
  const tFill = el("tFill");
  const tLabel = el("tLabel");

  // Focus
  const focusTitle = el("focusTitle");
  const focusMeta = el("focusMeta");
  const floatLine = el("floatLine");

  // Buttons
  const btnMenu = el("btnMenu");
  const btnNewDay = el("btnNewDay");
  const btnRoulette = el("btnRoulette");
  const btnDego = el("btnDego");
  const btnNotesTask = el("btnNotesTask");
  const btnNotesDay = el("btnNotesDay");
  const btnDone = el("btnDone");
  const btnSkip = el("btnSkip");

  // Drawer
  const overlay = el("overlay");
  const drawer = el("drawer");
  const btnClose = el("btnClose");
  const tabs = el("tabs");
  const drawerBody = el("drawerBody");
  const btnUndo = el("btnUndo");
  const btnRedo = el("btnRedo");

  // Toast + FX
  const toast = el("toast");
  const fxCanvas = el("fx");
  const fx = fxCanvas.getContext("2d");

  // UI toggles
  const topbar = el("topbar");
  const hint = el("hint");

  // Big end
  const win = el("win");
  const winTitle = el("winTitle");
  const winText = el("winText");
  const btnWinClose = el("btnWinClose");
  const btnWinNewDay = el("btnWinNewDay");

  // =========================
  // Default State
  // =========================
  function isoDay(d = new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function buildSets(){
    // 1) Admission unité 74 (5 patients, 3 items/patient)
    const adm = [];
    adm.push("UNITÉ 74 — ADMISSION");
    for(let i=1;i<=5;i++){
      adm.push(`- Patient ${i} — Voir le/la patient·e — 2 ethorions — importance 3`);
      adm.push(`- Patient ${i} — Faire la note d’admission — 3 ethorions — importance 3`);
      adm.push(`- Patient ${i} — Revoir / ajuster le traitement — 2 ethorions — importance 2`);
    }

    // 2) Sortie unité 74 (5 patients, 3 items/patient)
    const out = [];
    out.push("UNITÉ 74 — SORTIE");
    for(let i=1;i<=5;i++){
      out.push(`- Patient ${i} — Voir le/la patient·e — 2 ethorions — importance 3`);
      out.push(`- Patient ${i} — Faire la note de sortie — 3 ethorions — importance 3`);
      out.push(`- Patient ${i} — Vérifier / finaliser traitement & ordonnances — 2 ethorions — importance 2`);
    }

    // 3) Consultations (6 patients, 2 items/patient : voir + note)
    const consult = [];
    consult.push("CONSULTATIONS");
    for(let i=1;i<=6;i++){
      consult.push(`- Patient ${i} — Voir le/la patient·e — 2 ethorions — importance 3`);
      consult.push(`- Patient ${i} — Faire la note de consultation — 2 ethorions — importance 3`);
    }

    // 4) Set “quotidien utile” (administratif + organisation)
    const daily = [
      "QUOTIDIEN — SOUTIEN",
      "- Vérifier l’horaire des cours & adapter le planning consultations — 2 ethorions — importance 3",
      "- Trier l’inbox mails pro (5 minutes) — 1 ethorion — importance 2",
      "- Lister 3 priorités réelles (pas des fantasmes) — 1 ethorion — importance 2",
      "- Préparer 1 message / appel difficile — 2 ethorions — importance 2",
      "- Ranger / reset bureau (10 minutes) — 2 ethorions — importance 1",
      "- Micro-pause + eau + respiration (3 minutes) — 1 ethorion — importance 1"
    ];

    return [
      { id:"set_u74_adm", name:"U74 Admission", lines: adm },
      { id:"set_u74_out", name:"U74 Sortie", lines: out },
      { id:"set_consult", name:"Consultations", lines: consult },
      { id:"set_daily", name:"Quotidien", lines: daily }
    ];
  }

  function initial(){
    const today = isoDay();
    return {
      version: 2,
      day: { id: today, startTasks: 0, startEth: 0 },
      focusId: null,

      // roulette bias
      energyProfile: { level: 2, motivation: 2 }, // 1..3

      // UI
      ui: {
        activeTab: "inbox",
        sort: "order",
        topbarHidden: false,
        hintHidden: false
      },

      // Data
      tasks: [],
      sets: buildSets(),

      // Notes
      dayNotes: "", // persistent notes for the day
      history: { undo: [], redo: [] },
      events: []
    };
  }

  let state = load() || initial();

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.tasks)) return null;

      // migrations / defaults
      if(!obj.sets) obj.sets = buildSets();
      if(!obj.history) obj.history = {undo:[], redo:[]};
      if(!obj.events) obj.events = [];
      if(!obj.energyProfile) obj.energyProfile = {level:2, motivation:2};
      if(!obj.ui) obj.ui = {activeTab:"inbox", sort:"order", topbarHidden:false, hintHidden:false};
      if(!obj.day) obj.day = initial().day;
      if(typeof obj.dayNotes !== "string") obj.dayNotes = "";

      obj.version = 2;
      return obj;
    }catch{ return null; }
  }

  // =========================
  // History (undo/redo) + visible log
  // =========================
  function snapshot(){
    const s = structuredClone({...state});
    s.history = {undo:[], redo:[]};
    return s;
  }

  function logEvent(text){
    state.events.push({ t: now(), text: String(text).slice(0,220) });
    state.events = state.events.slice(-250);
  }

  function pushHistory(label){
    state.history.undo.push(snapshot());
    if(state.history.undo.length > MAX_HISTORY) state.history.undo.shift();
    state.history.redo = [];
    if(label) logEvent(label);
    save();
    updateUndoRedo();
  }

  function undo(){
    if(!state.history.undo.length) return;
    const prev = state.history.undo.pop();
    const cur = snapshot();
    state.history.redo.push(cur);
    const keep = state.history;
    state = {...prev, history: keep};
    save();
    renderAll();
  }

  function redo(){
    if(!state.history.redo.length) return;
    const next = state.history.redo.pop();
    const cur = snapshot();
    state.history.undo.push(cur);
    const keep = state.history;
    state = {...next, history: keep};
    save();
    renderAll();
  }

  function updateUndoRedo(){
    btnUndo.disabled = state.history.undo.length===0;
    btnRedo.disabled = state.history.redo.length===0;
  }

  // =========================
  // Parsing
  // =========================
  function cleanLine(s){
    let x = String(s||"").trim();
    x = x.replace(/[|¦]+/g," ").replace(/\s{2,}/g," ").trim();
    return x;
  }

  function isTaskLine(line){ return /^-\s+/.test(line); }
  function stripTaskPrefix(line){ return line.replace(/^-+\s*/, "").trim(); }

  function parseEthorion(text){
    const t = text.toLowerCase();
    const m = t.match(/(\d{1,2})\s*(?:ethorion|ethorions|eth)\b/);
    if(m) return clamp(parseInt(m[1],10)||1, 1, 50);
    return null;
  }

  function parseMinutes(text){
    const t = text.toLowerCase();
    const m = t.match(/(\d{1,3})\s*(?:minutes|minute|min)\b/);
    if(m) return clamp(parseInt(m[1],10)||0, 1, 999);
    return null;
  }

  function parseImportance(text){
    const t = text.toLowerCase();
    const m = t.match(/\b(?:importance|prio|priorité)\s*(\d)\b/);
    if(m) return clamp(parseInt(m[1],10)||2, 1, 3);
    return null;
  }

  function removeMetaFromTitle(raw){
    let x = raw.replace(/\s*[—–]\s*/g, " – ");
    const parts = x.split(" – ").map(p=>p.trim()).filter(Boolean);
    return (parts[0] || raw).trim();
  }

  function inferEnergyFromText(title, category){
    const t = (title+" "+(category||"")).toLowerCase();
    // low energy: calls, emails, quick admin
    if(/\b(appeler|tél|tel|téléphone|mail|email|ranger|trier|encoder|encodage)\b/.test(t)) return 1;
    // high energy: long writing / complex analysis
    if(/\b(rapport|rédaction|dossier|analyse|note d’admission|note de sortie)\b/.test(t)) return 3;
    return 2;
  }

  function parsePasted(raw){
    const lines = String(raw||"").split(/\r?\n/).map(cleanLine);
    let currentCategory = "Sans catégorie";
    const out = [];

    for(const line0 of lines){
      const line = line0.trim();
      if(!line) continue;

      if(!isTaskLine(line)){
        currentCategory = line.replace(/:+$/,"").trim() || currentCategory;
        continue;
      }

      const body = stripTaskPrefix(line);

      const eth = parseEthorion(body) ?? 3;
      const minutes = parseMinutes(body);
      const prio = parseImportance(body) ?? 2;

      const title = cleanLine(removeMetaFromTitle(body));
      out.push({
        title,
        category: currentCategory,
        ethorionTotal: eth,
        ethorionRemaining: eth,
        minutesHint: minutes || null,
        priority: prio,
        energyTag: inferEnergyFromText(title, currentCategory)
      });
    }
    return out;
  }

  // =========================
  // Day baseline
  // =========================
  function ensureDay(){
    const today = isoDay();
    if(state.day.id !== today){
      state.day.id = today;
      state.day.startTasks = 0;
      state.day.startEth = 0;
      // dayNotes intentionally kept (your choice) — if you want per-day notes, we can key by date
    }
    if(state.day.startTasks===0 && state.day.startEth===0){
      setDayBaseline("Départ fixé");
    }
  }

  function setDayBaseline(label){
    const active = state.tasks.filter(t=>!t.done);
    state.day.startTasks = active.length;
    state.day.startEth = active.reduce((a,t)=>a + (t.ethorionRemaining||0), 0);
    logEvent(label || "Départ fixé");
    save();
  }

  function newDay(){
    pushHistory("Nouveau jour");
    setDayBaseline("Nouveau jour");
    renderAll();
    showToast("Nouveau jour.", 2400);
  }

  // =========================
  // Tasks
  // =========================
  function nextOrder(){
    const act = state.tasks.filter(t=>!t.done);
    if(!act.length) return 1;
    return Math.max(...act.map(t=>t.order||0)) + 1;
  }

  function addTasksFromText(raw){
    const parsed = parsePasted(raw);
    if(!parsed.length){
      showToast("Rien (vérifie les tirets).", 2600);
      return;
    }
    pushHistory(`Ajout ${parsed.length} tâche(s)`);

    const start = nextOrder();
    parsed.forEach((p,i)=>{
      state.tasks.push({
        id: uid(),
        title: p.title,
        category: p.category,
        ethorionTotal: p.ethorionTotal,
        ethorionRemaining: p.ethorionRemaining,
        minutesHint: p.minutesHint,
        priority: p.priority,
        energyTag: p.energyTag,
        notes: "",
        done: false,
        order: start+i,
        createdAt: now(),
        doneAt: null
      });
    });

    ensureDay();
    if(!state.focusId){
      const t = pickWeightedTask();
      if(t) state.focusId = t.id;
    }

    save();
    renderAll();
    showToast("Ajouté.", 2200);
  }

  function getTask(id){ return state.tasks.find(t=>t.id===id) || null; }

  function setFocus(id){
    state.focusId = id;
    save();
    renderFocus();
  }

  function finishTask(taskId, opts={}){
    const t = getTask(taskId);
    if(!t) return;

    if(!opts.silent) pushHistory("Terminer tâche");

    t.done = true;
    t.doneAt = now();
    t.ethorionRemaining = 0;

    // celebration (regular)
    confettiDots(1.6);
    flash(0.10);

    // surprise chance (violent-ish, intermittent)
    maybeSurprise("task");

    showToast(pick(DONE_LINES), 3200);

    const next = pickWeightedTask();
    state.focusId = next ? next.id : null;

    save();
    renderAll();
    checkWin();
  }

  function degoOne(){
    const t = getTask(state.focusId);
    if(!t){
      showToast("CIBLE INDISPONIBLE.", 2400);
      return;
    }

    pushHistory("Dégommage");
    t.ethorionRemaining = Math.max(0, (t.ethorionRemaining||0) - 1);

    // roulette vibe: small visual reward
    confettiDots(0.9);
    flash(0.08);

    // surprise chance (small)
    maybeSurprise("eth");

    showToast(pick(LINES), 2400);

    if(t.ethorionRemaining===0){
      finishTask(t.id, {silent:true});
      return;
    }

    save();
    renderAll();
  }

  function skip(){
    const next = pickWeightedTask();
    state.focusId = next ? next.id : null;
    save();
    renderAll();
    showToast(next ? "CIBLE CHANGÉE." : "PLUS DE CIBLES.", 2200);
    if(!next) checkWin();
  }

  function deleteTask(taskId){
    if(!confirm("Supprimer ?")) return;
    pushHistory("Supprimer tâche");
    if(state.focusId === taskId) state.focusId = null;
    state.tasks = state.tasks.filter(x=>x.id!==taskId);
    save();
    renderAll();
    checkWin();
  }

  function duplicateTask(taskId){
    const t = getTask(taskId);
    if(!t) return;
    pushHistory("Dupliquer tâche");
    const c = structuredClone(t);
    c.id = uid();
    c.done = false;
    c.doneAt = null;
    c.ethorionRemaining = c.ethorionTotal;
    c.order = nextOrder();
    c.createdAt = now();
    state.tasks.push(c);
    save();
    renderAll();
    showToast("Dupliqué.", 2000);
  }

  function setEthorion(taskId){
    const t = getTask(taskId);
    if(!t || t.done) return;
    const val = prompt("ETHORION total ?", String(t.ethorionTotal||3));
    if(val===null) return;

    pushHistory("Régler ethorion");
    const n = clamp(parseInt(val,10)||t.ethorionTotal||3, 1, 50);

    const wasTotal = Math.max(1, t.ethorionTotal||1);
    const wasRem = clamp(t.ethorionRemaining||0, 0, wasTotal);
    const ratio = wasTotal ? (wasRem/wasTotal) : 1;

    t.ethorionTotal = n;
    t.ethorionRemaining = clamp(Math.round(n*ratio), 0, n);
    if(t.ethorionRemaining===0) t.ethorionRemaining = Math.min(1,n);

    save();
    renderAll();
    showToast("OK", 1600);
  }

  // =========================
  // Weighted roulette with energy/motivation
  // =========================
  function pickWeightedTask(){
    const pool = state.tasks.filter(t=>!t.done && (t.ethorionRemaining||0) > 0);
    if(!pool.length) return null;

    const E = state.energyProfile.level;      // 1..3
    const M = state.energyProfile.motivation; // 1..3

    const weights = pool.map(t=>{
      const rem = Math.max(1, Math.ceil(t.ethorionRemaining||1));
      const pr = (t.priority===3? 3 : t.priority===2? 2 : 1);

      let fit = 1.0;
      if(E===1){
        fit *= (t.energyTag===1 ? 1.55 : t.energyTag===2 ? 0.95 : 0.55);
      }else if(E===2){
        fit *= (t.energyTag===1 ? 1.10 : t.energyTag===2 ? 1.30 : 0.95);
      }else{
        fit *= (t.energyTag===3 ? 1.35 : 1.05);
      }

      let mot = 1.0;
      if(M===1){
        mot *= (rem<=2 ? 1.55 : rem<=4 ? 1.05 : 0.70);
      }else if(M===2){
        mot *= (rem<=3 ? 1.15 : 1.0);
      }else{
        mot *= 1.0;
      }

      return Math.max(0.2, rem * pr * fit * mot);
    });

    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for(let i=0;i<pool.length;i++){
      r -= weights[i];
      if(r<=0) return pool[i];
    }
    return pool[pool.length-1];
  }

  // Roulette suspense
  let rouletteLock = false;
  function roulette(){
    if(rouletteLock) return;
    rouletteLock = true;
    btnRoulette.disabled = true;
    btnRoulette.classList.add("spinning");

    setFloat("scan…");
    showToast("Roulette…", 1100);

    const suspense = 720 + Math.floor(Math.random()*420);

    setTimeout(()=>{
      const t = pickWeightedTask();
      if(t){
        state.focusId = t.id;
        setFloat(pick(FLOAT_LOCK));
        showToast("CIBLE VERROUILLÉE.", 2200);
        confettiDots(1.1);
        flash(0.10);
        maybeSurprise("roulette");
      }else{
        state.focusId = null;
        setFloat("—");
        showToast("PLUS DE CIBLES.", 2200);
      }

      btnRoulette.disabled = false;
      btnRoulette.classList.remove("spinning");
      rouletteLock = false;

      save();
      renderAll();
      checkWin();
    }, suspense);
  }

  // =========================
  // Sorting + drag reorder (Liste)
  // =========================
  function getActiveSorted(){
    const items = state.tasks.filter(t=>!t.done);
    const sort = state.ui.sort || "order";
    if(sort==="prio"){
      items.sort((a,b)=>(b.priority||2)-(a.priority||2) || (a.order||0)-(b.order||0));
    }else if(sort==="eth"){
      items.sort((a,b)=>(b.ethorionRemaining||0)-(a.ethorionRemaining||0) || (b.priority||2)-(a.priority||2));
    }else if(sort==="cat"){
      items.sort((a,b)=> (a.category||"").localeCompare(b.category||"", "fr") || (a.order||0)-(b.order||0));
    }else{
      items.sort((a,b)=>(a.order||0)-(b.order||0));
    }
    return items;
  }

  function applyOrderFromList(ids){
    let k = 1;
    ids.forEach(id=>{
      const t = getTask(id);
      if(t && !t.done) t.order = k++;
    });
  }

  // =========================
  // Rendering
  // =========================
  function sumActiveEth(){
    return state.tasks.reduce((a,t)=>a + (t.done?0:(t.ethorionRemaining||0)), 0);
  }
  function countActiveTasks(){
    return state.tasks.filter(t=>!t.done).length;
  }

  function renderCounters(){
    ensureDay();

    const leftTasks = countActiveTasks();
    const leftEth = sumActiveEth();

    const startT = state.day.startTasks || leftTasks;
    const startE = state.day.startEth || leftEth;

    const elimEth = Math.max(0, startE - leftEth);

    startTasksEl.textContent = String(startT);
    leftTasksEl.textContent  = String(leftTasks);
    startEthEl.textContent   = String(startE);
    leftEthEl.textContent    = String(leftEth);
    elimEthEl.textContent    = String(elimEth);

    const denom = Math.max(1, startE);
    const pctLeft = clamp(Math.round((leftEth/denom)*100), 0, 100);
    gFill.style.width = `${pctLeft}%`;
    gLabel.textContent = `${pctLeft}%`; // hidden, but kept for possible future toggles

    updateUndoRedo();
  }

  function renderFocus(){
    const t = getTask(state.focusId);
    if(!t){
      focusTitle.textContent = "CIBLE EN COURS DE RECHERCHE";
      focusMeta.textContent = "—";
      tFill.style.width = "100%";
      tLabel.textContent = "100%";

      btnDego.disabled = true;
      btnNotesTask.disabled = true;
      btnDone.disabled = true;
      btnSkip.disabled = false;

      // button label
      btnDego.textContent = "Dégommer 1 ethorion";
      return;
    }

    focusTitle.textContent = t.title;

    const hintMin = t.minutesHint ? ` · ${t.minutesHint} min` : "";
    const pr = `P${t.priority}`;
    const cat = t.category || "Sans catégorie";
    focusMeta.textContent = `${cat} · ${pr}${hintMin}`;

    // Button label stays brutal & clear
    btnDego.textContent = `Dégommer 1 ethorion (${t.ethorionRemaining}/${t.ethorionTotal})`;

    const total = Math.max(1, t.ethorionTotal||1);
    const rem = clamp(t.ethorionRemaining||0, 0, total);
    const pctLeft = clamp(Math.round((rem/total)*100), 0, 100);
    tFill.style.width = `${pctLeft}%`;
    tLabel.textContent = `${pctLeft}%`; // hidden

    btnDego.disabled = false;
    btnNotesTask.disabled = false;
    btnDone.disabled = false;

    if(!floatLine.textContent || floatLine.textContent==="—"){
      setFloat(pick(FLOAT_IDLE));
    }
  }

  function renderAll(){
    // UI toggles
    topbar.classList.toggle("hidden", !!state.ui.topbarHidden);
    hint.classList.toggle("hidden", !!state.ui.hintHidden);

    renderCounters();
    renderFocus();
    renderDrawer();
  }

  // =========================
  // Drawer Tabs + Content
  // =========================
  const TAB_DEFS = [
    { key:"inbox",   label:"Inbox" },
    { key:"liste",   label:"Liste" },
    { key:"cats",    label:"Cat" },
    { key:"sets",    label:"Sets" },
    { key:"energie", label:"Énergie" },
    { key:"notes",   label:"Notes" },
    { key:"hist",    label:"Hist" },
    { key:"rapport", label:"Rapport" },
    { key:"ui",      label:"UI" }
  ];

  function setTab(key){
    state.ui.activeTab = key;
    save();
    renderDrawer();
  }

  function renderTabs(){
    tabs.innerHTML = "";
    TAB_DEFS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (state.ui.activeTab===t.key ? " active" : "");
      b.textContent = t.label;
      b.addEventListener("click", ()=> setTab(t.key));
      tabs.appendChild(b);
    });
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function miniBarPct(rem, total){
    total = Math.max(1, total||1);
    rem = clamp(rem||0, 0, total);
    return clamp(Math.round((rem/total)*100), 0, 100);
  }

  function renderTaskRow(t, {draggable=false}={}){
    const row = document.createElement("div");
    row.className = "trow";
    row.dataset.id = t.id;

    const pct = miniBarPct(t.ethorionRemaining, t.ethorionTotal);

    row.innerHTML = `
      <div class="trowTop">
        <div style="min-width:0;">
          <div class="tname ${t.done ? "done":""}">${esc(t.title)}</div>
          <div class="tmini">
            <span>${esc(t.category || "Sans catégorie")}</span>
            <span>·</span>
            <span>P${esc(String(t.priority || 2))}</span>
            <span>·</span>
            <span>ETH ${esc(String(t.ethorionRemaining||0))}/${esc(String(t.ethorionTotal||0))}</span>
          </div>
        </div>
        <div class="tacts">
          ${!t.done ? `<button class="btn" data-a="focus">Focus</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="eth">Eth</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="dup">Dupl</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="ok">OK</button>` : ""}
          <button class="btn" data-a="x">X</button>
        </div>
      </div>
      <div class="sbarMiniWrap" aria-label="Progression">
        <div class="sbarMiniFill" style="width:${pct}%"></div>
      </div>
    `;

    row.querySelectorAll("[data-a]").forEach(btn=>{
      const a = btn.dataset.a;
      btn.addEventListener("click", ()=>{
        if(a==="focus"){ setFocus(t.id); renderAll(); }
        if(a==="eth"){ setEthorion(t.id); }
        if(a==="dup"){ duplicateTask(t.id); }
        if(a==="ok"){ finishTask(t.id); }
        if(a==="x"){ deleteTask(t.id); }
      });
    });

    if(draggable && !t.done){
      row.draggable = true;
      row.style.cursor = "grab";
    }

    return row;
  }

  function renderDrawerInbox(){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="cardTitle"><span>Inbox</span><span>Ctrl/⌘+Enter</span></div>
      <textarea id="inboxTA" placeholder="Catégorie
- Tâche – 3 ethorions – 15 minutes – importance 2
- …"></textarea>
      <div class="rowBtns">
        <button class="btn" id="btnAdd">Ajouter</button>
      </div>
    `;
    const ta = card.querySelector("#inboxTA");
    const add = card.querySelector("#btnAdd");

    add.addEventListener("click", ()=>{
      addTasksFromText(ta.value);
      ta.value = "";
    });

    ta.addEventListener("keydown", (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==="Enter"){
        e.preventDefault();
        add.click();
      }
    });

    return card;
  }

  function renderDrawerList(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle">
        <span>Liste</span>
        <span>
          <select id="sortSel" aria-label="Tri">
            <option value="order">Tri: ordre</option>
            <option value="prio">Tri: priorité</option>
            <option value="eth">Tri: ethorion</option>
            <option value="cat">Tri: catégorie</option>
          </select>
        </span>
      </div>
      <div class="list" id="taskList"></div>
      <details>
        <summary>Terminé</summary>
        <div class="inside">
          <div class="list" id="doneList"></div>
        </div>
      </details>
    `;

    const sortSel = wrap.querySelector("#sortSel");
    sortSel.value = state.ui.sort || "order";
    sortSel.addEventListener("change", ()=>{
      pushHistory("Tri");
      state.ui.sort = sortSel.value;
      save();
      renderDrawer();
    });

    const list = wrap.querySelector("#taskList");
    const items = getActiveSorted();
    const draggable = (state.ui.sort==="order");

    items.forEach(t=> list.appendChild(renderTaskRow(t, {draggable})));

    if(draggable){
      let dragId = null;

      list.addEventListener("dragstart", (e)=>{
        const row = e.target.closest(".trow");
        if(!row) return;
        dragId = row.dataset.id;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", dragId);
      });

      list.addEventListener("dragover", (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      list.addEventListener("drop", (e)=>{
        e.preventDefault();
        const targetRow = e.target.closest(".trow");
        if(!targetRow) return;

        const fromId = e.dataTransfer.getData("text/plain") || dragId;
        const toId = targetRow.dataset.id;
        if(!fromId || !toId || fromId===toId) return;

        const rows = [...list.querySelectorAll(".trow")];
        const fromEl = rows.find(r=>r.dataset.id===fromId);
        const toEl = rows.find(r=>r.dataset.id===toId);
        if(!fromEl || !toEl) return;

        pushHistory("Réordonner");

        const rect = toEl.getBoundingClientRect();
        const after = (e.clientY - rect.top) > rect.height/2;
        if(after) toEl.after(fromEl);
        else toEl.before(fromEl);

        const ids = [...list.querySelectorAll(".trow")].map(r=>r.dataset.id);
        applyOrderFromList(ids);

        save();
        renderDrawer();
        showToast("Ordre mis à jour.", 2000);
      });
    }

    const doneList = wrap.querySelector("#doneList");
    state.tasks
      .filter(t=>t.done)
      .sort((a,b)=>(b.doneAt||0)-(a.doneAt||0))
      .slice(0, 60)
      .forEach(t=> doneList.appendChild(renderTaskRow(t)));

    return wrap;
  }

  function groupByCategory(tasks){
    const m = new Map();
    tasks.forEach(t=>{
      const k = t.category || "Sans catégorie";
      if(!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });
    const keys = [...m.keys()].sort((a,b)=>a.localeCompare(b, "fr"));
    return {m, keys};
  }

  function renderDrawerCats(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>Catégories</span><span>clic pour ouvrir</span></div>`;

    const items = getActiveSorted();
    const {m, keys} = groupByCategory(items);

    keys.forEach(cat=>{
      const det = document.createElement("details");
      det.open = false;
      const sumEth = m.get(cat).reduce((a,t)=>a+(t.ethorionRemaining||0),0);
      const sum = document.createElement("summary");
      sum.textContent = `${cat} — ETH ${sumEth}`;
      det.appendChild(sum);

      const inside = document.createElement("div");
      inside.className = "inside";
      const list = document.createElement("div");
      list.className = "list";
      m.get(cat).forEach(t=> list.appendChild(renderTaskRow(t)));
      inside.appendChild(list);
      det.appendChild(inside);

      wrap.appendChild(det);
    });

    return wrap;
  }

  function renderDrawerSets(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>Sets</span><span>préenregistrés + perso</span></div>
      <div class="list" id="setsList"></div>
      <details>
        <summary>Créer / éditer set</summary>
        <div class="inside" id="setEditorHost"></div>
      </details>
    `;

    const list = wrap.querySelector("#setsList");
    const host = wrap.querySelector("#setEditorHost");

    state.sets.forEach(s=>{
      const row = document.createElement("div");
      row.className = "trow";
      row.innerHTML = `
        <div class="trowTop">
          <div>
            <div class="tname">${esc(s.name)}</div>
            <div class="tmini">${esc(String((s.lines||[]).length))} lignes</div>
          </div>
          <div class="tacts">
            <button class="btn" data-a="apply">Appliquer</button>
            <button class="btn" data-a="edit">Éditer</button>
            <button class="btn" data-a="del">X</button>
          </div>
        </div>
      `;

      row.querySelector('[data-a="apply"]').addEventListener("click", ()=>{
        addTasksFromText((s.lines||[]).join("\n"));
        showToast("Set appliqué.", 2000);
      });

      row.querySelector('[data-a="edit"]').addEventListener("click", ()=>{
        host.innerHTML = "";
        host.appendChild(renderSetEditor(s.id));
        row.closest("details")?.setAttribute("open","true");
      });

      row.querySelector('[data-a="del"]').addEventListener("click", ()=>{
        if(!confirm("Supprimer set ?")) return;
        pushHistory("Supprimer set");
        state.sets = state.sets.filter(x=>x.id!==s.id);
        save();
        renderDrawer();
      });

      list.appendChild(row);
    });

    // empty editor by default
    host.appendChild(renderSetEditor(null));

    return wrap;
  }

  function renderSetEditor(setId){
    const s = setId ? state.sets.find(x=>x.id===setId) : null;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="cardTitle"><span>${s ? "Éditer set" : "Nouveau set"}</span><span>lignes “-” = tâches</span></div>
      <input type="text" id="setName" placeholder="Nom du set" value="${esc(s ? s.name : "")}">
      <textarea id="setLines" placeholder="Catégorie
- tâche – 3 ethorions – importance 2
- tâche">${esc(s ? (s.lines||[]).join("\n") : "")}</textarea>
      <div class="rowBtns">
        <button class="btn" id="btnSaveSet">Enregistrer</button>
        <button class="btn" id="btnApplySetNow">Appliquer</button>
      </div>
    `;

    const name = card.querySelector("#setName");
    const lines = card.querySelector("#setLines");
    const saveBtn = card.querySelector("#btnSaveSet");
    const applyBtn = card.querySelector("#btnApplySetNow");

    saveBtn.addEventListener("click", ()=>{
      const n = cleanLine(name.value).slice(0,40);
      const ls = String(lines.value||"").split(/\r?\n/).map(cleanLine).filter(Boolean);
      if(!n){ showToast("Nom ?", 2000); return; }
      if(!ls.length){ showToast("Lignes ?", 2000); return; }

      pushHistory("Enregistrer set");

      if(s){
        s.name = n;
        s.lines = ls;
      }else{
        state.sets.push({ id:"set_"+uid(), name:n, lines: ls });
      }
      save();
      renderDrawer();
      showToast("OK", 1800);
    });

    applyBtn.addEventListener("click", ()=>{
      if(!lines.value.trim()){ showToast("Rien à appliquer.", 1800); return; }
      addTasksFromText(lines.value);
      showToast("Set appliqué.", 1800);
    });

    return card;
  }

  function renderDrawerEnergy(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>Énergie</span><span>influence roulette</span></div>
      <select id="lvl">
        <option value="1">Énergie: basse</option>
        <option value="2">Énergie: moyenne</option>
        <option value="3">Énergie: haute</option>
      </select>
      <select id="mot">
        <option value="1">Motivation: basse</option>
        <option value="2">Motivation: moyenne</option>
        <option value="3">Motivation: haute</option>
      </select>
      <div class="rowBtns">
        <button class="btn" id="btnApply">Appliquer</button>
      </div>
    `;

    const lvl = wrap.querySelector("#lvl");
    const mot = wrap.querySelector("#mot");
    lvl.value = String(state.energyProfile.level||2);
    mot.value = String(state.energyProfile.motivation||2);

    wrap.querySelector("#btnApply").addEventListener("click", ()=>{
      pushHistory("Énergie réglée");
      state.energyProfile.level = parseInt(lvl.value,10);
      state.energyProfile.motivation = parseInt(mot.value,10);
      save();
      renderAll();
      showToast("OK", 1800);
      setFloat(pick(FLOAT_IDLE));
    });

    return wrap;
  }

  function renderDrawerNotes(){
    const wrap = document.createElement("div");
    wrap.className = "card";

    const t = getTask(state.focusId);

    wrap.innerHTML = `
      <div class="cardTitle"><span>Notes</span><span>persistantes</span></div>

      <details ${state.dayNotes ? "open" : ""}>
        <summary>Notes jour (ne s’effacent pas)</summary>
        <div class="inside">
          <textarea id="dayNotesTA" placeholder="Notes au vol… (gardées dans le système)">${esc(state.dayNotes||"")}</textarea>
          <div class="rowBtns">
            <button class="btn" id="btnSaveDayNotes">Enregistrer</button>
            <button class="btn" id="btnCopyDayNotes">Copier</button>
            <button class="btn" id="btnMailtoDayNotes">Mailto</button>
          </div>
          <div class="tmini">“Mailto” ouvre ton client mail avec le texte pré-rempli (pas d’envoi automatique).</div>
        </div>
      </details>

      <details ${t && t.notes ? "open" : ""}>
        <summary>Notes tâche (cible en cours)</summary>
        <div class="inside">
          <div class="tmini">${t ? esc(t.title) : "Aucune cible"}</div>
          <textarea id="taskNotesTA" placeholder="Notes tâche…">${esc(t ? (t.notes||"") : "")}</textarea>
          <div class="rowBtns">
            <button class="btn" id="btnSaveTaskNotes" ${t ? "" : "disabled"}>Enregistrer</button>
            <button class="btn" id="btnCopyTaskNotes" ${t ? "" : "disabled"}>Copier</button>
          </div>
        </div>
      </details>
    `;

    const dayTA = wrap.querySelector("#dayNotesTA");
    const taskTA = wrap.querySelector("#taskNotesTA");

    wrap.querySelector("#btnSaveDayNotes").addEventListener("click", ()=>{
      pushHistory("Notes jour");
      state.dayNotes = String(dayTA.value||"").slice(0, 20000);
      save();
      showToast("Notes jour OK.", 1800);
    });

    wrap.querySelector("#btnCopyDayNotes").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(String(dayTA.value||""));
        showToast("Copié.", 1400);
      }catch{
        showToast("Copie impossible (navigateur).", 2000);
      }
    });

    wrap.querySelector("#btnMailtoDayNotes").addEventListener("click", ()=>{
      const subject = encodeURIComponent(`Notes — ${state.day.id}`);
      const body = encodeURIComponent(String(dayTA.value||""));
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    if(t){
      wrap.querySelector("#btnSaveTaskNotes").addEventListener("click", ()=>{
        pushHistory("Notes tâche");
        t.notes = String(taskTA.value||"").slice(0, 20000);
        save();
        showToast("Notes tâche OK.", 1800);
        renderAll();
      });

      wrap.querySelector("#btnCopyTaskNotes").addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(String(taskTA.value||""));
          showToast("Copié.", 1400);
        }catch{
          showToast("Copie impossible (navigateur).", 2000);
        }
      });
    }

    return wrap;
  }

  function renderDrawerHist(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>Historique</span><span>visible</span></div>`;

    const list = document.createElement("div");
    list.className = "list";

    state.events.slice().reverse().slice(0, 140).forEach(ev=>{
      const row = document.createElement("div");
      row.className = "trow";
      const d = new Date(ev.t);
      const ts = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      row.innerHTML = `<div class="tmini"><b>${esc(ts)}</b> · ${esc(ev.text)}</div>`;
      list.appendChild(row);
    });

    wrap.appendChild(list);
    return wrap;
  }

  function renderDrawerRapport(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>Rapport</span><span>jour</span></div>`;

    const active = state.tasks.filter(t=>!t.done);
    const done = state.tasks.filter(t=>t.done);

    const leftTasks = active.length;
    const leftEth = active.reduce((a,t)=>a+(t.ethorionRemaining||0),0);

    const startT = state.day.startTasks || 0;
    const startE = state.day.startEth || 0;
    const doneTasks = done.length;
    const elimEth = Math.max(0, startE - leftEth);

    const box = document.createElement("div");
    box.className = "trow";
    box.innerHTML = `
      <div class="tname">Aujourd’hui (${esc(state.day.id)})</div>
      <div class="tmini">Départ: ${esc(String(startT))} tâches · ${esc(String(startE))} ETH</div>
      <div class="tmini">Reste: ${esc(String(leftTasks))} tâches · ${esc(String(leftEth))} ETH</div>
      <div class="tmini">Éliminé: ${esc(String(elimEth))} ETH · Terminé: ${esc(String(doneTasks))} tâches</div>
    `;

    wrap.appendChild(box);

    // by category
    const byCat = {};
    state.tasks.forEach(t=>{
      const c = t.category || "Sans catégorie";
      if(!byCat[c]) byCat[c] = { n:0, total:0, left:0 };
      byCat[c].n++;
      byCat[c].total += (t.ethorionTotal||0);
      byCat[c].left += (t.done?0:(t.ethorionRemaining||0));
    });

    const list = document.createElement("div");
    list.className = "list";
    Object.keys(byCat).sort((a,b)=>a.localeCompare(b,"fr")).forEach(c=>{
      const r = byCat[c];
      const row = document.createElement("div");
      row.className = "trow";
      row.innerHTML = `
        <div class="tname">${esc(c)}</div>
        <div class="tmini">${esc(String(r.n))} tâches · ETH ${esc(String(r.left))}/${esc(String(r.total))}</div>
      `;
      list.appendChild(row);
    });

    // quick copy
    const txt = [
      `ELIMINATOR — Rapport du ${state.day.id}`,
      `Départ: ${startT} tâches · ${startE} ETH`,
      `Reste: ${leftTasks} tâches · ${leftEth} ETH`,
      `Éliminé: ${elimEth} ETH · Terminé: ${doneTasks} tâches`,
      "",
      ...Object.keys(byCat).sort((a,b)=>a.localeCompare(b,"fr")).map(c=>{
        const r = byCat[c];
        return `${c}: ${r.n} tâches · ETH ${r.left}/${r.total}`;
      })
    ].join("\n");

    const actions = document.createElement("div");
    actions.className = "rowBtns";
    actions.innerHTML = `
      <button class="btn" id="btnCopyReport">Copier</button>
      <button class="btn" id="btnMailtoReport">Mailto</button>
    `;

    actions.querySelector("#btnCopyReport").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(txt);
        showToast("Rapport copié.", 1600);
      }catch{
        showToast("Copie impossible (navigateur).", 2000);
      }
    });

    actions.querySelector("#btnMailtoReport").addEventListener("click", ()=>{
      const subject = encodeURIComponent(`Rapport — ${state.day.id}`);
      const body = encodeURIComponent(txt);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    wrap.appendChild(list);
    wrap.appendChild(actions);
    return wrap;
  }

  function renderDrawerUI(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>UI</span><span>options affichage</span></div>

      <div class="trow">
        <div class="tname">Affichage</div>
        <div class="tmini">Moins d’encadrés = déjà fait côté centre. Ici tu règles ce qui apparaît.</div>
      </div>

      <div class="trow">
        <div class="trowTop">
          <div>
            <div class="tname">Topbar</div>
            <div class="tmini">Masquer la barre du haut (compteurs + menu).</div>
          </div>
          <div class="tacts">
            <button class="btn" id="btnToggleTopbar">${state.ui.topbarHidden ? "Afficher" : "Masquer"}</button>
          </div>
        </div>
      </div>

      <div class="trow">
        <div class="trowTop">
          <div>
            <div class="tname">Hint</div>
            <div class="tmini">Masquer la ligne d’aide en bas.</div>
          </div>
          <div class="tacts">
            <button class="btn" id="btnToggleHint">${state.ui.hintHidden ? "Afficher" : "Masquer"}</button>
          </div>
        </div>
      </div>

      <div class="trow">
        <div class="trowTop">
          <div>
            <div class="tname">Reset</div>
            <div class="tmini">Supprime tout (tâches, sets perso, notes, historique). Irréversible.</div>
          </div>
          <div class="tacts">
            <button class="btn" id="btnHardReset">Reset</button>
          </div>
        </div>
      </div>
    `;

    wrap.querySelector("#btnToggleTopbar").addEventListener("click", ()=>{
      pushHistory("UI topbar");
      state.ui.topbarHidden = !state.ui.topbarHidden;
      save();
      renderAll();
    });

    wrap.querySelector("#btnToggleHint").addEventListener("click", ()=>{
      pushHistory("UI hint");
      state.ui.hintHidden = !state.ui.hintHidden;
      save();
      renderAll();
    });

    wrap.querySelector("#btnHardReset").addEventListener("click", ()=>{
      if(!confirm("Reset total ?")) return;
      localStorage.removeItem(LS_KEY);
      state = initial();
      save();
      closeDrawer();
      renderAll();
      showToast("Reset OK.", 2000);
    });

    return wrap;
  }

  function renderDrawer(){
    renderTabs();
    drawerBody.innerHTML = "";

    const tab = state.ui.activeTab || "inbox";
    if(tab==="inbox") drawerBody.appendChild(renderDrawerInbox());
    else if(tab==="liste") drawerBody.appendChild(renderDrawerList());
    else if(tab==="cats") drawerBody.appendChild(renderDrawerCats());
    else if(tab==="sets") drawerBody.appendChild(renderDrawerSets());
    else if(tab==="energie") drawerBody.appendChild(renderDrawerEnergy());
    else if(tab==="notes") drawerBody.appendChild(renderDrawerNotes());
    else if(tab==="hist") drawerBody.appendChild(renderDrawerHist());
    else if(tab==="rapport") drawerBody.appendChild(renderDrawerRapport());
    else if(tab==="ui") drawerBody.appendChild(renderDrawerUI());
    else drawerBody.appendChild(renderDrawerInbox());
  }

  // =========================
  // Drawer open/close + swipe close
  // =========================
  function openDrawer(){
    overlay.classList.add("show");
    drawer.classList.add("show");
    renderDrawer();
  }
  function closeDrawer(){
    overlay.classList.remove("show");
    drawer.classList.remove("show");
  }

  btnMenu.addEventListener("click", openDrawer);
  btnClose.addEventListener("click", closeDrawer);
  overlay.addEventListener("click", closeDrawer);

  // swipe to close (left panel)
  let touchX0 = null;
  drawer.addEventListener("pointerdown", (e)=>{
    if(e.pointerType==="mouse") return;
    touchX0 = e.clientX;
  });
  drawer.addEventListener("pointermove", (e)=>{
    if(touchX0===null) return;
    const dx = e.clientX - touchX0;
    if(dx < -80){
      touchX0 = null;
      closeDrawer();
    }
  });
  drawer.addEventListener("pointerup", ()=> touchX0 = null);
  drawer.addEventListener("pointercancel", ()=> touchX0 = null);

  // =========================
  // Buttons wiring
  // =========================
  btnNewDay.addEventListener("click", newDay);
  btnRoulette.addEventListener("click", roulette);
  btnDego.addEventListener("click", degoOne);

  btnNotesTask.addEventListener("click", ()=>{
    openDrawer();
    setTab("notes");
    showToast("Notes: tâche + jour.", 1400);
  });
  btnNotesDay.addEventListener("click", ()=>{
    openDrawer();
    setTab("notes");
    showToast("Notes
