<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ELIMINATOR</title>
  <style>
    :root{
      --bg:#0b0d12;
      --fg:#e9edf5;
      --muted:#a8b0bd;

      --panel:#121625;
      --panel2:#0d1020;

      --line:rgba(255,255,255,0.10);
      --soft:rgba(255,255,255,0.06);

      --chip:rgba(0,0,0,0.18);

      --accent1:#f2f2f2;
      --accent2:#aeb7c7;

      --shadow:0 18px 60px rgba(0,0,0,0.62);
      --r:24px;

      --glass: blur(10px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(242,242,242,0.10), transparent 62%),
        radial-gradient(900px 420px at 20% 20%, rgba(242,242,242,0.07), transparent 60%),
        linear-gradient(180deg, #07080c, var(--bg));
      color: var(--fg);
      overflow-x:hidden;
    }

    /* ====== FX Canvas ====== */
    canvas#fx{ position:fixed; inset:0; pointer-events:none; z-index: 110; }

    /* ====== App Shell ====== */
    .shell{
      min-height:100vh;
      display:grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 8px;
    }

    /* ====== Header OUTSIDE the panel ====== */
    .hero{
      padding: 18px 14px 0;
      display:grid;
      place-items:center;
      text-align:center;
      gap: 8px;
      user-select:none;
    }
    .hero h1{
      margin:0;
      font-size: clamp(34px, 6vw, 70px);
      font-weight: 1100;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      line-height:1;
      text-shadow: 0 12px 40px rgba(0,0,0,0.55);
    }
    .hero p{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      letter-spacing:0.16em;
      text-transform: uppercase;
    }
    .floatLine{
      min-height: 18px;
      color: rgba(242,242,242,0.86);
      font-weight: 900;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      opacity: 0.92;
    }

    /* ====== Top minimal bar ====== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      gap:10px;
    }
    .topbar.hidden{ display:none; }
    .topbar .left, .topbar .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .iconbtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.12);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:0.08em;
      text-transform: uppercase;
      font-size: 12px;
      user-select:none;
    }
    .iconbtn:hover{ border-color: rgba(242,242,242,0.22); }
    .iconbtn:active{ transform: translateY(1px); }
    .iconbtn:disabled{ opacity:0.5; cursor:not-allowed; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.12);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      user-select:none;
      white-space:nowrap;
    }
    .chip b{ color: var(--fg); font-weight: 1000; }

    /* ====== Stage ====== */
    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 14px 10px;
    }

    .focusCard{
      width: min(1040px, 96vw);
      border-radius: var(--r);
      border: 1px solid rgba(242,242,242,0.10);
      background:
        radial-gradient(980px 460px at 50% 0%, rgba(242,242,242,0.13), transparent 62%),
        linear-gradient(180deg, rgba(18,22,37,0.86), rgba(10,12,22,0.86));
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      padding: 18px;
      display:grid;
      gap: 14px;
      position:relative;
      overflow:hidden;
    }

    /* Big global bar (label hidden) */
    .barWrap{
      border-radius: 999px;
      height: 26px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .barFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 240ms ease;
    }
    .barLabel{ display:none; }

    /* Focus task area */
    .target{
      display:grid;
      gap: 10px;
      text-align:center;
      align-items:center;
    }
    .targetTitle{
      font-size: clamp(22px, 3.6vw, 34px);
      font-weight: 1100;
      line-height:1.15;
      word-break: break-word;
      padding: 0 6px;
    }
    .targetMeta{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:0.04em;
      line-height:1.2;
    }

    /* Small task bar (label hidden) */
    .sbarWrap{
      border-radius: 999px;
      height: 12px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
      max-width: min(760px, 92vw);
      margin: 0 auto;
    }
    .sbarFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(242,242,242,0.82), rgba(174,183,199,0.70));
      transition: width 200ms ease;
    }
    .sbarLabel{ display:none; }

    /* Actions */
    .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 16px;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    .btnRoulette{
      width: 112px; height: 112px;
      border-radius: 999px;
      border:1px solid rgba(242,242,242,0.22);
      background:
        radial-gradient(closest-side, rgba(242,242,242,0.22), rgba(0,0,0,0.06)),
        linear-gradient(180deg, #0b0d12, #070810);
      color: var(--fg);
      cursor:pointer;
      font-weight: 1100;
      letter-spacing:0.12em;
      text-transform: uppercase;
      display:grid;
      place-items:center;
      user-select:none;
      position:relative;
      box-shadow: 0 14px 40px rgba(0,0,0,0.50);
    }
    .btnRoulette .ring{ position:absolute; inset:12px; border-radius:999px; border:2px dashed rgba(255,255,255,0.18); opacity:0.80; }
    .btnRoulette .inner{ position:absolute; inset:26px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); opacity:0.85; }
    .btnRoulette:hover{ border-color: rgba(242,242,242,0.36); }
    .btnRoulette:active{ transform: translateY(1px); }
    .btnRoulette:disabled{ opacity:0.5; cursor:not-allowed; }
    .btnRoulette.spinning .ring{ animation: spin 520ms linear infinite; }
    .btnRoulette.spinning .inner{ animation: spin2 860ms linear infinite; }
    @keyframes spin{ from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }
    @keyframes spin2{ from{ transform: rotate(360deg);} to{ transform: rotate(0deg);} }

    .btnDego{
      border:1px solid rgba(242,242,242,0.18);
      background:
        radial-gradient(900px 260px at 50% 20%, rgba(242,242,242,0.12), transparent 62%),
        linear-gradient(180deg, #0b0d12, #070810);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color:var(--fg);
      border-radius: 20px;
      padding: 18px 20px;
      cursor:pointer;
      font-weight: 1100;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      min-height: 72px;
      min-width: min(700px, 86vw);
      box-shadow: 0 14px 40px rgba(0,0,0,0.45);
      position:relative;
      overflow:hidden;
    }
    .btnDego::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 120px at 50% 30%, rgba(242,242,242,0.10), transparent 60%);
      opacity:0.75;
      pointer-events:none;
      transition: opacity 180ms ease;
    }
    .btnDego:hover{ border-color: rgba(242,242,242,0.32); }
    .btnDego:hover::after{ opacity:1; }
    .btnDego:active{ transform: translateY(1px); }
    .btnDego:disabled{ opacity:0.5; cursor:not-allowed; }

    .subActions{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 2px;
    }

    .btn{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:0.08em;
      text-transform: uppercase;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(255,255,255,0.18); }
    .btn:active{ transform: translateY(1px); }

    .hint{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height:1.25;
      padding: 0 14px 18px;
      opacity:0.95;
    }
    .hint.hidden{ display:none; }

    /* ====== Drawer ====== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.56);
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease;
      z-index: 90;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .drawer{
      position:fixed; top:0; left:0;
      height:100vh;
      width: min(640px, 94vw);
      background:
        radial-gradient(900px 420px at 40% 0%, rgba(242,242,242,0.14), transparent 62%),
        linear-gradient(180deg, rgba(18,22,37,0.90), rgba(10,12,22,0.90));
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      border-right: 1px solid rgba(255,255,255,0.10);
      transform: translateX(-110%);
      transition: transform 180ms ease;
      z-index: 100;
      display:grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
      touch-action: pan-y;
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .drawerHeader .h{
      font-weight: 1000;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
    }

    /* Menu buttons INSIDE drawer (these must be functional) */
    .menuRow{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .tab{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      color: var(--fg);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:0.08em;
      text-transform: uppercase;
      user-select:none;
    }
    .tab.active{ border-color: rgba(242,242,242,0.26); }

    .drawerBody{ overflow:auto; padding-right: 4px; display:grid; gap: 12px; align-content:start; }

    .card{
      border:1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      background: rgba(0,0,0,0.10);
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .cardTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-weight: 1000;
      letter-spacing:0.14em;
      text-transform: uppercase;
      font-size: 11px;
    }

    textarea, select, input[type="text"]{
      font:inherit;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{ width:100%; min-height: 160px; resize: vertical; line-height:1.35; }
    textarea:focus, select:focus, input:focus{ border-color: rgba(242,242,242,0.22); }

    .rowBtns{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .list{ display:grid; gap:8px; }

    .trow{
      border:1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      background: rgba(0,0,0,0.12);
      padding: 10px;
      display:grid;
      gap:8px;
    }
    .trowTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .tname{ font-weight: 950; font-size: 14px; line-height:1.2; word-break: break-word; }
    .tmini{ color: var(--muted); font-size: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; line-height:1.15; }
    .tacts{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .done{ text-decoration: line-through; opacity:0.55; }

    .sbarMiniWrap{
      border-radius: 999px;
      height: 10px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .sbarMiniFill{
      height:100%;
      background: linear-gradient(90deg, rgba(242,242,242,0.78), rgba(174,183,199,0.62));
      transition: width 180ms ease;
    }

    details{
      border:1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,0.10);
    }
    summary{
      cursor:pointer;
      padding: 10px 12px;
      color: var(--muted);
      font-weight: 1000;
      letter-spacing:0.14em;
      text-transform: uppercase;
      font-size: 11px;
      user-select:none;
    }
    details > .inside{ padding: 10px 12px 12px; display:grid; gap:10px; }

    .toast{
      position:fixed;
      left:50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(9,10,14,0.84);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--fg);
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease, transform 160ms ease;
      max-width: min(920px, calc(100vw - 24px));
      box-shadow: var(--shadow);
      white-space:pre-wrap;
      z-index: 120;
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }

    /* Responsive */
    @media (max-width: 520px){
      .btnDego{ min-width: 92vw; }
      .focusCard{ padding: 16px; }
      .btnRoulette{ width: 98px; height:98px; }
      .hero h1{ letter-spacing: 0.14em; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="shell">

    <!-- TITLE / SUBTITLE / FLOATING LINE OUTSIDE PANEL -->
    <header class="hero">
      <h1>ELIMINATOR</h1>
      <p>Dégommez-les tous!</p>
      <div class="floatLine" id="floatLine">—</div>
    </header>

    <div class="topbar" id="topbar">
      <div class="left">
        <button class="iconbtn" id="btnMenu" aria-label="Menu">MENU</button>
        <button class="iconbtn" id="btnNewDay">Nouveau jour</button>
      </div>

      <div class="right chips" aria-label="Compteurs">
        <span class="chip">Départ <b id="startTasks">0</b> tâches</span>
        <span class="chip">Reste <b id="leftTasks">0</b> tâches</span>
        <span class="chip">ETH <b id="leftEth">0</b>/<b id="startEth">0</b></span>
        <span class="chip">Éliminé <b id="elimEth">0</b></span>
      </div>
    </div>

    <div class="stage">
      <section class="focusCard" aria-label="Focus">
        <div class="barWrap" aria-label="Progression globale">
          <div class="barFill" id="gFill"></div>
          <div class="barLabel" id="gLabel">100%</div>
        </div>

        <div class="target" aria-label="Cible">
          <div class="targetTitle" id="focusTitle">CIBLE EN COURS DE RECHERCHE</div>
          <div class="targetMeta" id="focusMeta">—</div>

          <div class="sbarWrap" aria-label="Progression tâche">
            <div class="sbarFill" id="tFill"></div>
            <div class="sbarLabel" id="tLabel">100%</div>
          </div>

          <div class="actions">
            <button class="btnRoulette" id="btnRoulette" aria-label="Roulette">
              <span class="ring"></span>
              <span class="inner"></span>
              R
            </button>

            <button class="btnDego" id="btnDego">Dégommer 1 ethorion</button>
          </div>

          <div class="subActions">
            <button class="btn" id="btnNotesTask">Notes tâche</button>
            <button class="btn" id="btnNotesDay">Notes jour</button>
            <button class="btn" id="btnDone">Terminer</button>
            <button class="btn" id="btnSkip">Passer</button>
          </div>
        </div>
      </section>
    </div>

    <div class="hint" id="hint">
      Import: catégories sur une ligne, tâches sur une ligne (tiret/puce/numéro). R=roulette · D=dégommage · M=menu · Ctrl/⌘+Enter=ajouter depuis inbox.
    </div>
  </div>

  <!-- Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-label="Menu latéral">
    <div class="drawerHeader">
      <div class="h">MENU</div>
      <button class="btn" id="btnClose">FERMER</button>
    </div>

    <!-- IMPORTANT: menu links that ACTUALLY NAVIGATE -->
    <div class="menuRow" id="tabs"></div>

    <div class="drawerBody" id="drawerBody"></div>

    <div class="rowBtns">
      <button class="btn" id="btnUndo">UNDO</button>
      <button class="btn" id="btnRedo">REDO</button>
    </div>
  </aside>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  "use strict";

  // =========================
  // Utils
  // =========================
  const LS_KEY = "eliminator_app_v3";
  const MAX_HISTORY = 60;

  const el = (id)=>document.getElementById(id);
  const now = ()=>Date.now();
  const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
  const uid = ()=> Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36);
  const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];

  function isoDay(d = new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  // =========================
  // Elements
  // =========================
  const startTasksEl = el("startTasks");
  const leftTasksEl  = el("leftTasks");
  const startEthEl   = el("startEth");
  const leftEthEl    = el("leftEth");
  const elimEthEl    = el("elimEth");

  const gFill = el("gFill");
  const gLabel = el("gLabel");
  const tFill = el("tFill");
  const tLabel = el("tLabel");

  const focusTitle = el("focusTitle");
  const focusMeta = el("focusMeta");
  const floatLine = el("floatLine");

  const btnMenu = el("btnMenu");
  const btnNewDay = el("btnNewDay");
  const btnRoulette = el("btnRoulette");
  const btnDego = el("btnDego");
  const btnNotesTask = el("btnNotesTask");
  const btnNotesDay = el("btnNotesDay");
  const btnDone = el("btnDone");
  const btnSkip = el("btnSkip");

  const overlay = el("overlay");
  const drawer = el("drawer");
  const btnClose = el("btnClose");
  const tabs = el("tabs");
  const drawerBody = el("drawerBody");
  const btnUndo = el("btnUndo");
  const btnRedo = el("btnRedo");

  const toast = el("toast");
  const fxCanvas = el("fx");
  const fx = fxCanvas.getContext("2d");

  const topbar = el("topbar");
  const hint = el("hint");

  // =========================
  // Lines / Floating text
  // =========================
  const FLOAT_IDLE = [
    "respire. une cible à la fois.",
    "petit pas, gros nettoyage.",
    "tu as le droit d’aller vite… et de t’arrêter.",
    "objectif: une action. pas un roman.",
    "prends la cible. dégomme l’eth. recommence."
  ];
  const FLOAT_LOCK = [
    "cible verrouillée.",
    "priorité capturée.",
    "tu sais ce que tu fais. (même si tu doutes).",
    "ok. maintenant: exécution.",
    "on avance."
  ];
  const LINES = [
    "ETHORION DÉGOMMÉ.",
    "BIM. UN EN MOINS.",
    "PROPRE.",
    "ÇA BAISSE. ET TOI TU MONTES.",
    "C’EST FAIT."
  ];
  const DONE_LINES = [
    "TÂCHE TERMINÉE.",
    "CIBLE ÉLIMINÉE.",
    "FINI. NEXT.",
    "C’EST RANGÉ DANS LE PASSÉ.",
    "OK. PAS MAL."
  ];

  function setFloat(text){ floatLine.textContent = (text && String(text).trim()) ? text : "—"; }

  // =========================
  // State
  // =========================
  function buildSets(){
    const adm = [];
    adm.push("UNITÉ 74 — ADMISSION");
    for(let i=1;i<=5;i++){
      adm.push(`- Patient ${i} — Voir le/la patient·e — 2 ethorions — importance 3`);
      adm.push(`- Patient ${i} — Note d’admission — 3 ethorions — importance 3`);
      adm.push(`- Patient ${i} — Traitement (revue/ajustement) — 2 ethorions — importance 2`);
    }

    const out = [];
    out.push("UNITÉ 74 — SORTIE");
    for(let i=1;i<=5;i++){
      out.push(`- Patient ${i} — Voir le/la patient·e — 2 ethorions — importance 3`);
      out.push(`- Patient ${i} — Note de sortie — 3 ethorions — importance 3`);
      out.push(`- Patient ${i} — Ordonnances / plan — 2 ethorions — importance 2`);
    }

    const consult = [];
    consult.push("CONSULTATIONS");
    for(let i=1;i<=6;i++){
      consult.push(`- Patient ${i} — Voir le/la patient·e — 2 ethorions — importance 3`);
      consult.push(`- Patient ${i} — Note de consultation — 2 ethorions — importance 3`);
    }

    const daily = [
      "QUOTIDIEN — SOUTIEN",
      "- Vérifier horaires cours + adapter planning consults — 2 ethorions — importance 3",
      "- Trier inbox mails pro (5 min) — 1 ethorion — importance 2",
      "- Lister 3 priorités réelles — 1 ethorion — importance 2",
      "- Préparer 1 message/appel difficile — 2 ethorions — importance 2",
      "- Reset bureau (10 min) — 2 ethorions — importance 1",
      "- Micro-pause eau + respiration (3 min) — 1 ethorion — importance 1"
    ];

    return [
      { id:"set_u74_adm", name:"U74 Admission", lines: adm },
      { id:"set_u74_out", name:"U74 Sortie", lines: out },
      { id:"set_consult", name:"Consultations", lines: consult },
      { id:"set_daily", name:"Quotidien", lines: daily }
    ];
  }

  function initial(){
    const today = isoDay();
    return {
      version: 3,
      day: { id: today, startTasks: 0, startEth: 0 },
      focusId: null,

      energyProfile: { level: 2, motivation: 2 }, // 1..3

      ui: {
        activeTab: "inbox",
        sort: "order",
        topbarHidden: false,
        hintHidden: false
      },

      tasks: [],
      sets: buildSets(),

      dayNotes: "",
      history: { undo: [], redo: [] },
      events: []
    };
  }

  let state = load() || initial();

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.tasks)) return null;

      if(!obj.sets) obj.sets = buildSets();
      if(!obj.history) obj.history = {undo:[], redo:[]};
      if(!obj.events) obj.events = [];
      if(!obj.energyProfile) obj.energyProfile = {level:2, motivation:2};
      if(!obj.ui) obj.ui = {activeTab:"inbox", sort:"order", topbarHidden:false, hintHidden:false};
      if(!obj.day) obj.day = initial().day;
      if(typeof obj.dayNotes !== "string") obj.dayNotes = "";
      obj.version = 3;
      return obj;
    }catch{ return null; }
  }

  // =========================
  // History (undo/redo) + visible log
  // =========================
  function snapshot(){
    const s = structuredClone({...state});
    s.history = {undo:[], redo:[]};
    return s;
  }

  function logEvent(text){
    state.events.push({ t: now(), text: String(text).slice(0,240) });
    state.events = state.events.slice(-260);
  }

  function pushHistory(label){
    state.history.undo.push(snapshot());
    if(state.history.undo.length > MAX_HISTORY) state.history.undo.shift();
    state.history.redo = [];
    if(label) logEvent(label);
    save();
    updateUndoRedo();
  }

  function undo(){
    if(!state.history.undo.length) return;
    const prev = state.history.undo.pop();
    const cur = snapshot();
    state.history.redo.push(cur);
    const keep = state.history;
    state = {...prev, history: keep};
    save();
    renderAll();
  }

  function redo(){
    if(!state.history.redo.length) return;
    const next = state.history.redo.pop();
    const cur = snapshot();
    state.history.undo.push(cur);
    const keep = state.history;
    state = {...next, history: keep};
    save();
    renderAll();
  }

  function updateUndoRedo(){
    btnUndo.disabled = state.history.undo.length===0;
    btnRedo.disabled = state.history.redo.length===0;
  }

  // =========================
  // Parsing (accept multiple formats)
  // =========================
  function cleanLine(s){
    return String(s||"").replace(/[|¦]+/g," ").replace(/\s{2,}/g," ").trim();
  }

  function isTaskLike(line){
    // Accept: "- task", "• task", "* task", "1) task", "1. task", "— task"
    return /^(\s*[-*•—–]\s+|\s*\d+[\.\)]\s+)/.test(line);
  }

  function stripTaskPrefix(line){
    return line.replace(/^(\s*[-*•—–]\s+|\s*\d+[\.\)]\s+)/, "").trim();
  }

  function parseEthorion(text){
    const t = text.toLowerCase();
    const m = t.match(/(\d{1,2})\s*(?:ethorion|ethorions|eth)\b/);
    if(m) return clamp(parseInt(m[1],10)||1, 1, 50);
    return null;
  }
  function parseMinutes(text){
    const t = text.toLowerCase();
    const m = t.match(/(\d{1,3})\s*(?:minutes|minute|min)\b/);
    if(m) return clamp(parseInt(m[1],10)||0, 1, 999);
    return null;
  }
  function parseImportance(text){
    const t = text.toLowerCase();
    const m = t.match(/\b(?:importance|prio|priorité)\s*(\d)\b/);
    if(m) return clamp(parseInt(m[1],10)||2, 1, 3);
    return null;
  }

  function removeMetaFromTitle(raw){
    let x = raw.replace(/\s*[—–]\s*/g, " – ");
    const parts = x.split(" – ").map(p=>p.trim()).filter(Boolean);
    return (parts[0] || raw).trim();
  }

  function inferEnergyFromText(title, category){
    const t = (title+" "+(category||"")).toLowerCase();
    if(/\b(appeler|tél|tel|téléphone|mail|email|ranger|trier|encoder|encodage)\b/.test(t)) return 1;
    if(/\b(rapport|rédaction|dossier|analyse|note d’admission|note de sortie)\b/.test(t)) return 3;
    return 2;
  }

  function parsePasted(raw){
    const lines = String(raw||"").split(/\r?\n/).map(cleanLine);
    let currentCategory = "Sans catégorie";
    const out = [];

    for(const line0 of lines){
      const line = line0.trim();
      if(!line) continue;

      // Category line if not task-like
      if(!isTaskLike(line)){
        currentCategory = line.replace(/:+$/,"").trim() || currentCategory;
        continue;
      }

      const body = stripTaskPrefix(line);

      const eth = parseEthorion(body) ?? 3;
      const minutes = parseMinutes(body);
      const prio = parseImportance(body) ?? 2;

      const title = cleanLine(removeMetaFromTitle(body));
      if(!title) continue;

      out.push({
        title,
        category: currentCategory,
        ethorionTotal: eth,
        ethorionRemaining: eth,
        minutesHint: minutes || null,
        priority: prio,
        energyTag: inferEnergyFromText(title, currentCategory)
      });
    }
    return out;
  }

  // =========================
  // Day baseline
  // =========================
  function ensureDay(){
    const today = isoDay();
    if(state.day.id !== today){
      state.day.id = today;
      state.day.startTasks = 0;
      state.day.startEth = 0;
      logEvent("Changement de jour");
    }
    if(state.day.startTasks===0 && state.day.startEth===0){
      setDayBaseline("Départ fixé");
    }
  }

  function setDayBaseline(label){
    const active = state.tasks.filter(t=>!t.done);
    state.day.startTasks = active.length;
    state.day.startEth = active.reduce((a,t)=>a + (t.ethorionRemaining||0), 0);
    logEvent(label || "Départ fixé");
    save();
  }

  function newDay(){
    pushHistory("Nouveau jour");
    setDayBaseline("Nouveau jour");
    renderAll();
    showToast("Nouveau jour.", 2000);
  }

  // =========================
  // Tasks
  // =========================
  function nextOrder(){
    const act = state.tasks.filter(t=>!t.done);
    return act.length ? (Math.max(...act.map(t=>t.order||0)) + 1) : 1;
  }

  function addTasksFromText(raw){
    const parsed = parsePasted(raw);
    if(!parsed.length){
      showToast("Rien détecté. Mets des puces/tirets/numéros.", 2800);
      return;
    }
    pushHistory(`Ajout ${parsed.length} tâche(s)`);

    const start = nextOrder();
    parsed.forEach((p,i)=>{
      state.tasks.push({
        id: uid(),
        title: p.title,
        category: p.category,
        ethorionTotal: p.ethorionTotal,
        ethorionRemaining: p.ethorionRemaining,
        minutesHint: p.minutesHint,
        priority: p.priority,
        energyTag: p.energyTag,
        notes: "",
        done: false,
        order: start+i,
        createdAt: now(),
        doneAt: null
      });
    });

    ensureDay();
    if(!state.focusId){
      const t = pickWeightedTask();
      if(t) state.focusId = t.id;
    }

    save();
    renderAll();
    showToast("Ajouté.", 2000);
  }

  function getTask(id){ return state.tasks.find(t=>t.id===id) || null; }

  function setFocus(id){
    state.focusId = id;
    save();
    renderFocus();
  }

  // =========================
  // Weighted roulette
  // =========================
  function pickWeightedTask(){
    const pool = state.tasks.filter(t=>!t.done && (t.ethorionRemaining||0) > 0);
    if(!pool.length) return null;

    const E = state.energyProfile.level;
    const M = state.energyProfile.motivation;

    const weights = pool.map(t=>{
      const rem = Math.max(1, Math.ceil(t.ethorionRemaining||1));
      const pr = (t.priority===3? 3 : t.priority===2? 2 : 1);

      let fit = 1.0;
      if(E===1) fit *= (t.energyTag===1 ? 1.55 : t.energyTag===2 ? 0.95 : 0.55);
      else if(E===2) fit *= (t.energyTag===1 ? 1.10 : t.energyTag===2 ? 1.30 : 0.95);
      else fit *= (t.energyTag===3 ? 1.35 : 1.05);

      let mot = 1.0;
      if(M===1) mot *= (rem<=2 ? 1.55 : rem<=4 ? 1.05 : 0.70);
      else if(M===2) mot *= (rem<=3 ? 1.15 : 1.0);

      return Math.max(0.2, rem * pr * fit * mot);
    });

    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for(let i=0;i<pool.length;i++){
      r -= weights[i];
      if(r<=0) return pool[i];
    }
    return pool[pool.length-1];
  }

  let rouletteLock = false;
  function roulette(){
    if(rouletteLock) return;
    rouletteLock = true;
    btnRoulette.disabled = true;
    btnRoulette.classList.add("spinning");

    setFloat("scan…");
    showToast("Roulette…", 1200);

    const suspense = 720 + Math.floor(Math.random()*420);
    setTimeout(()=>{
      const t = pickWeightedTask();
      if(t){
        state.focusId = t.id;
        setFloat(pick(FLOAT_LOCK));
        showToast("Cible verrouillée.", 2000);
        flash(0.10);
      }else{
        state.focusId = null;
        setFloat("—");
        showToast("Plus de cibles.", 2000);
      }

      btnRoulette.disabled = false;
      btnRoulette.classList.remove("spinning");
      rouletteLock = false;

      save();
      renderAll();
    }, suspense);
  }

  function finishTask(taskId){
    const t = getTask(taskId);
    if(!t) return;

    pushHistory("Terminer tâche");
    t.done = true;
    t.doneAt = now();
    t.ethorionRemaining = 0;

    flash(0.10);
    showToast(pick(DONE_LINES), 2400);

    const next = pickWeightedTask();
    state.focusId = next ? next.id : null;

    save();
    renderAll();
  }

  function degoOne(){
    const t = getTask(state.focusId);
    if(!t){
      showToast("CIBLE INDISPONIBLE.", 2200);
      return;
    }

    pushHistory("Dégommage");
    t.ethorionRemaining = Math.max(0, (t.ethorionRemaining||0) - 1);

    flash(0.08);
    showToast(pick(LINES), 2000);

    if(t.ethorionRemaining===0){
      finishTask(t.id);
      return;
    }

    save();
    renderAll();
  }

  function skip(){
    const next = pickWeightedTask();
    state.focusId = next ? next.id : null;
    save();
    renderAll();
    showToast(next ? "CIBLE CHANGÉE." : "PLUS DE CIBLES.", 2000);
  }

  // =========================
  // Sorting + list helpers
  // =========================
  function getActiveSorted(){
    const items = state.tasks.filter(t=>!t.done);
    const sort = state.ui.sort || "order";
    if(sort==="prio"){
      items.sort((a,b)=>(b.priority||2)-(a.priority||2) || (a.order||0)-(b.order||0));
    }else if(sort==="eth"){
      items.sort((a,b)=>(b.ethorionRemaining||0)-(a.ethorionRemaining||0) || (b.priority||2)-(a.priority||2));
    }else if(sort==="cat"){
      items.sort((a,b)=> (a.category||"").localeCompare(b.category||"", "fr") || (a.order||0)-(b.order||0));
    }else{
      items.sort((a,b)=>(a.order||0)-(b.order||0));
    }
    return items;
  }

  function sumActiveEth(){
    return state.tasks.reduce((a,t)=>a + (t.done?0:(t.ethorionRemaining||0)), 0);
  }
  function countActiveTasks(){
    return state.tasks.filter(t=>!t.done).length;
  }

  // =========================
  // Rendering: counters, bars, focus
  // =========================
  function renderCounters(){
    ensureDay();

    const leftTasks = countActiveTasks();
    const leftEth = sumActiveEth();

    const startT = state.day.startTasks || leftTasks;
    const startE = state.day.startEth || leftEth;

    const elimEth = Math.max(0, startE - leftEth);

    startTasksEl.textContent = String(startT);
    leftTasksEl.textContent  = String(leftTasks);
    startEthEl.textContent   = String(startE);
    leftEthEl.textContent    = String(leftEth);
    elimEthEl.textContent    = String(elimEth);

    // Global bar: start full and decreases
    const denom = Math.max(1, startE);
    const pctLeft = clamp(Math.round((leftEth/denom)*100), 0, 100);
    gFill.style.width = `${pctLeft}%`;
    gLabel.textContent = `${pctLeft}%`;

    updateUndoRedo();
  }

  function renderFocus(){
    const t = getTask(state.focusId);
    if(!t){
      focusTitle.textContent = "CIBLE EN COURS DE RECHERCHE";
      focusMeta.textContent = "—";
      tFill.style.width = "100%";
      tLabel.textContent = "100%";
      btnDego.disabled = true;
      btnNotesTask.disabled = true;
      btnDone.disabled = true;
      btnSkip.disabled = false;
      btnDego.textContent = "Dégommer 1 ethorion";
      if(floatLine.textContent==="—") setFloat(pick(FLOAT_IDLE));
      return;
    }

    focusTitle.textContent = t.title;

    const hintMin = t.minutesHint ? ` · ${t.minutesHint} min` : "";
    const pr = `P${t.priority}`;
    const cat = t.category || "Sans catégorie";
    focusMeta.textContent = `${cat} · ${pr}${hintMin}`;

    btnDego.textContent = `Dégommer 1 ethorion (${t.ethorionRemaining}/${t.ethorionTotal})`;

    const total = Math.max(1, t.ethorionTotal||1);
    const rem = clamp(t.ethorionRemaining||0, 0, total);
    const pctLeft = clamp(Math.round((rem/total)*100), 0, 100);
    tFill.style.width = `${pctLeft}%`;
    tLabel.textContent = `${pctLeft}%`;

    btnDego.disabled = false;
    btnNotesTask.disabled = false;
    btnDone.disabled = false;

    if(!floatLine.textContent || floatLine.textContent==="—"){
      setFloat(pick(FLOAT_IDLE));
    }
  }

  function renderAll(){
    topbar.classList.toggle("hidden", !!state.ui.topbarHidden);
    hint.classList.toggle("hidden", !!state.ui.hintHidden);

    renderCounters();
    renderFocus();
    renderDrawer(); // keeps menu functional
  }

  // =========================
  // Drawer tabs: THESE are the menu links you wanted
  // =========================
  const TAB_DEFS = [
    { key:"inbox",   label:"INBOX" },
    { key:"liste",   label:"LISTE" },
    { key:"cats",    label:"CAT" },
    { key:"sets",    label:"SETS" },
    { key:"energie", label:"ÉNERGIE" },
    { key:"notes",   label:"NOTES" },
    { key:"hist",    label:"HIST" },
    { key:"rapport", label:"RAPPORT" },
    { key:"ui",      label:"UI" }
  ];

  function openDrawer(tabKey){
    overlay.classList.add("show");
    drawer.classList.add("show");
    if(tabKey) state.ui.activeTab = tabKey;
    save();
    renderDrawer();
  }
  function closeDrawer(){
    overlay.classList.remove("show");
    drawer.classList.remove("show");
  }

  function setTab(key){
    state.ui.activeTab = key;
    save();
    renderDrawer();
  }

  function renderTabs(){
    tabs.innerHTML = "";
    TAB_DEFS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (state.ui.activeTab===t.key ? " active" : "");
      b.textContent = t.label;
      b.addEventListener("click", ()=> setTab(t.key));
      tabs.appendChild(b);
    });
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function miniBarPct(rem, total){
    total = Math.max(1, total||1);
    rem = clamp(rem||0, 0, total);
    return clamp(Math.round((rem/total)*100), 0, 100);
  }

  function renderTaskRow(t){
    const row = document.createElement("div");
    row.className = "trow";
    const pct = miniBarPct(t.ethorionRemaining, t.ethorionTotal);

    row.innerHTML = `
      <div class="trowTop">
        <div style="min-width:0;">
          <div class="tname ${t.done ? "done":""}">${esc(t.title)}</div>
          <div class="tmini">
            <span>${esc(t.category || "Sans catégorie")}</span>
            <span>·</span>
            <span>P${esc(String(t.priority || 2))}</span>
            <span>·</span>
            <span>ETH ${esc(String(t.ethorionRemaining||0))}/${esc(String(t.ethorionTotal||0))}</span>
          </div>
        </div>
        <div class="tacts">
          ${!t.done ? `<button class="btn" data-a="focus">FOCUS</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="ok">OK</button>` : ""}
        </div>
      </div>
      <div class="sbarMiniWrap"><div class="sbarMiniFill" style="width:${pct}%"></div></div>
    `;

    row.querySelectorAll("[data-a]").forEach(btn=>{
      const a = btn.dataset.a;
      btn.addEventListener("click", ()=>{
        if(a==="focus"){ setFocus(t.id); renderAll(); closeDrawer(); }
        if(a==="ok"){ finishTask(t.id); }
      });
    });

    return row;
  }

  function renderDrawerInbox(){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="cardTitle"><span>INBOX</span><span>Ctrl/⌘+Enter</span></div>
      <textarea id="inboxTA" placeholder="Catégorie
- Tâche – 3 ethorions – 15 minutes – importance 2
• Autre tâche…
1) Autre format…"></textarea>
      <div class="rowBtns"><button class="btn" id="btnAdd">AJOUTER</button></div>
    `;
    const ta = card.querySelector("#inboxTA");
    const add = card.querySelector("#btnAdd");

    add.addEventListener("click", ()=>{
      addTasksFromText(ta.value);
      ta.value = "";
      setFloat(pick(FLOAT_LOCK));
    });

    ta.addEventListener("keydown", (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==="Enter"){
        e.preventDefault();
        add.click();
      }
    });

    return card;
  }

  function renderDrawerList(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle">
        <span>LISTE</span>
        <span>
          <select id="sortSel" aria-label="Tri">
            <option value="order">Tri: ordre</option>
            <option value="prio">Tri: priorité</option>
            <option value="eth">Tri: ethorion</option>
            <option value="cat">Tri: catégorie</option>
          </select>
        </span>
      </div>
      <div class="list" id="taskList"></div>
      <details>
        <summary>TERMINÉ</summary>
        <div class="inside"><div class="list" id="doneList"></div></div>
      </details>
    `;

    const sortSel = wrap.querySelector("#sortSel");
    sortSel.value = state.ui.sort || "order";
    sortSel.addEventListener("change", ()=>{
      pushHistory("Tri");
      state.ui.sort = sortSel.value;
      save();
      renderDrawer();
    });

    const list = wrap.querySelector("#taskList");
    getActiveSorted().forEach(t=> list.appendChild(renderTaskRow(t)));

    const doneList = wrap.querySelector("#doneList");
    state.tasks
      .filter(t=>t.done)
      .sort((a,b)=>(b.doneAt||0)-(a.doneAt||0))
      .slice(0, 80)
      .forEach(t=> doneList.appendChild(renderTaskRow(t)));

    return wrap;
  }

  function groupByCategory(tasks){
    const m = new Map();
    tasks.forEach(t=>{
      const k = t.category || "Sans catégorie";
      if(!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });
    const keys = [...m.keys()].sort((a,b)=>a.localeCompare(b, "fr"));
    return {m, keys};
  }

  function renderDrawerCats(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>CATÉGORIES</span><span>groupées</span></div>`;

    const items = state.tasks.filter(t=>!t.done);
    const {m, keys} = groupByCategory(items);

    keys.forEach(cat=>{
      const det = document.createElement("details");
      const sumEth = m.get(cat).reduce((a,t)=>a+(t.ethorionRemaining||0),0);
      const sum = document.createElement("summary");
      sum.textContent = `${cat} — ETH ${sumEth}`;
      det.appendChild(sum);

      const inside = document.createElement("div");
      inside.className = "inside";
      const list = document.createElement("div");
      list.className = "list";
      m.get(cat).forEach(t=> list.appendChild(renderTaskRow(t)));
      inside.appendChild(list);
      det.appendChild(inside);

      wrap.appendChild(det);
    });

    return wrap;
  }

  function renderDrawerSets(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>SETS</span><span>appliquer</span></div>
      <div class="list" id="setsList"></div>
    `;

    const list = wrap.querySelector("#setsList");
    state.sets.forEach(s=>{
      const row = document.createElement("div");
      row.className = "trow";
      row.innerHTML = `
        <div class="trowTop">
          <div>
            <div class="tname">${esc(s.name)}</div>
            <div class="tmini">${esc(String((s.lines||[]).length))} lignes</div>
          </div>
          <div class="tacts"><button class="btn" data-a="apply">APPLIQUER</button></div>
        </div>
      `;
      row.querySelector('[data-a="apply"]').addEventListener("click", ()=>{
        addTasksFromText((s.lines||[]).join("\n"));
        showToast("Set appliqué.", 1800);
        setFloat(pick(FLOAT_LOCK));
      });
      list.appendChild(row);
    });

    return wrap;
  }

  function renderDrawerEnergy(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>ÉNERGIE</span><span>influence roulette</span></div>
      <select id="lvl">
        <option value="1">Énergie: basse</option>
        <option value="2">Énergie: moyenne</option>
        <option value="3">Énergie: haute</option>
      </select>
      <select id="mot">
        <option value="1">Motivation: basse</option>
        <option value="2">Motivation: moyenne</option>
        <option value="3">Motivation: haute</option>
      </select>
      <div class="rowBtns"><button class="btn" id="btnApply">APPLIQUER</button></div>
    `;

    const lvl = wrap.querySelector("#lvl");
    const mot = wrap.querySelector("#mot");
    lvl.value = String(state.energyProfile.level||2);
    mot.value = String(state.energyProfile.motivation||2);

    wrap.querySelector("#btnApply").addEventListener("click", ()=>{
      pushHistory("Énergie réglée");
      state.energyProfile.level = parseInt(lvl.value,10);
      state.energyProfile.motivation = parseInt(mot.value,10);
      save();
      renderAll();
      showToast("OK", 1400);
      setFloat(pick(FLOAT_IDLE));
    });

    return wrap;
  }

  function renderDrawerNotes(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    const t = getTask(state.focusId);

    wrap.innerHTML = `
      <div class="cardTitle"><span>NOTES</span><span>persistantes</span></div>

      <details open>
        <summary>NOTES JOUR</summary>
        <div class="inside">
          <textarea id="dayNotesTA" placeholder="Notes au vol…">${esc(state.dayNotes||"")}</textarea>
          <div class="rowBtns"><button class="btn" id="btnSaveDayNotes">ENREGISTRER</button></div>
        </div>
      </details>

      <details ${t && t.notes ? "open" : ""}>
        <summary>NOTES TÂCHE</summary>
        <div class="inside">
          <div class="tmini">${t ? esc(t.title) : "Aucune cible"}</div>
          <textarea id="taskNotesTA" placeholder="Notes tâche…">${esc(t ? (t.notes||"") : "")}</textarea>
          <div class="rowBtns"><button class="btn" id="btnSaveTaskNotes" ${t ? "" : "disabled"}>ENREGISTRER</button></div>
        </div>
      </details>
    `;

    const dayTA = wrap.querySelector("#dayNotesTA");
    wrap.querySelector("#btnSaveDayNotes").addEventListener("click", ()=>{
      pushHistory("Notes jour");
      state.dayNotes = String(dayTA.value||"").slice(0, 20000);
      save();
      showToast("Notes jour OK.", 1500);
    });

    if(t){
      const taskTA = wrap.querySelector("#taskNotesTA");
      wrap.querySelector("#btnSaveTaskNotes").addEventListener("click", ()=>{
        pushHistory("Notes tâche");
        t.notes = String(taskTA.value||"").slice(0, 20000);
        save();
        showToast("Notes tâche OK.", 1500);
      });
    }

    return wrap;
  }

  function renderDrawerHist(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>HISTORIQUE</span><span>visible</span></div>`;

    const list = document.createElement("div");
    list.className = "list";

    state.events.slice().reverse().slice(0, 160).forEach(ev=>{
      const row = document.createElement("div");
      row.className = "trow";
      const d = new Date(ev.t);
      const ts = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      row.innerHTML = `<div class="tmini"><b>${esc(ts)}</b> · ${esc(ev.text)}</div>`;
      list.appendChild(row);
    });

    wrap.appendChild(list);
    return wrap;
  }

  function renderDrawerRapport(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>RAPPORT</span><span>jour</span></div>`;

    const active = state.tasks.filter(t=>!t.done);
    const done = state.tasks.filter(t=>t.done);

    const leftTasks = active.length;
    const leftEth = active.reduce((a,t)=>a+(t.ethorionRemaining||0),0);

    const startT = state.day.startTasks || 0;
    const startE = state.day.startEth || 0;
    const doneTasks = done.length;
    const elimEth = Math.max(0, startE - leftEth);

    const box = document.createElement("div");
    box.className = "trow";
    box.innerHTML = `
      <div class="tname">Aujourd’hui (${esc(state.day.id)})</div>
      <div class="tmini">Départ: ${esc(String(startT))} tâches · ${esc(String(startE))} ETH</div>
      <div class="tmini">Reste: ${esc(String(leftTasks))} tâches · ${esc(String(leftEth))} ETH</div>
      <div class="tmini">Éliminé: ${esc(String(elimEth))} ETH · Terminé: ${esc(String(doneTasks))} tâches</div>
    `;
    wrap.appendChild(box);

    return wrap;
  }

  function renderDrawerUI(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>UI</span><span>affichage</span></div>

      <div class="trow">
        <div class="trowTop">
          <div>
            <div class="tname">Topbar</div>
            <div class="tmini">Masquer/afficher les compteurs.</div>
          </div>
          <div class="tacts">
            <button class="btn" id="btnToggleTopbar">${state.ui.topbarHidden ? "AFFICHER" : "MASQUER"}</button>
          </div>
        </div>
      </div>

      <div class="trow">
        <div class="trowTop">
          <div>
            <div class="tname">Hint</div>
            <div class="tmini">Masquer/afficher l’aide.</div>
          </div>
          <div class="tacts">
            <button class="btn" id="btnToggleHint">${state.ui.hintHidden ? "AFFICHER" : "MASQUER"}</button>
          </div>
        </div>
      </div>

      <div class="trow">
        <div class="trowTop">
          <div>
            <div class="tname">Reset</div>
            <div class="tmini">Efface tout. Irréversible.</div>
          </div>
          <div class="tacts">
            <button class="btn" id="btnHardReset">RESET</button>
          </div>
        </div>
      </div>
    `;

    wrap.querySelector("#btnToggleTopbar").addEventListener("click", ()=>{
      pushHistory("UI topbar");
      state.ui.topbarHidden = !state.ui.topbarHidden;
      save();
      renderAll();
    });

    wrap.querySelector("#btnToggleHint").addEventListener("click", ()=>{
      pushHistory("UI hint");
      state.ui.hintHidden = !state.ui.hintHidden;
      save();
      renderAll();
    });

    wrap.querySelector("#btnHardReset").addEventListener("click", ()=>{
      if(!confirm("Reset total ?")) return;
      localStorage.removeItem(LS_KEY);
      state = initial();
      save();
      closeDrawer();
      renderAll();
      showToast("Reset OK.", 1600);
    });

    return wrap;
  }

  function renderDrawer(){
    renderTabs();
    drawerBody.innerHTML = "";

    const tab = state.ui.activeTab || "inbox";
    if(tab==="inbox") drawerBody.appendChild(renderDrawerInbox());
    else if(tab==="liste") drawerBody.appendChild(renderDrawerList());
    else if(tab==="cats") drawerBody.appendChild(renderDrawerCats());
    else if(tab==="sets") drawerBody.appendChild(renderDrawerSets());
    else if(tab==="energie") drawerBody.appendChild(renderDrawerEnergy());
    else if(tab==="notes") drawerBody.appendChild(renderDrawerNotes());
    else if(tab==="hist") drawerBody.appendChild(renderDrawerHist());
    else if(tab==="rapport") drawerBody.appendChild(renderDrawerRapport());
    else if(tab==="ui") drawerBody.appendChild(renderDrawerUI());
    else drawerBody.appendChild(renderDrawerInbox());
  }

  // =========================
  // Menu wiring (the thing you asked)
  // =========================
  btnMenu.addEventListener("click", ()=> openDrawer(state.ui.activeTab));
  btnClose.addEventListener("click", closeDrawer);
  overlay.addEventListener("click", closeDrawer);

  // swipe to close
  let touchX0 = null;
  drawer.addEventListener("pointerdown", (e)=>{
    if(e.pointerType==="mouse") return;
    touchX0 = e.clientX;
  });
  drawer.addEventListener("pointermove", (e)=>{
    if(touchX0===null) return;
    const dx = e.clientX - touchX0;
    if(dx < -80){ touchX0 = null; closeDrawer(); }
  });
  drawer.addEventListener("pointerup", ()=> touchX0 = null);
  drawer.addEventListener("pointercancel", ()=> touchX0 = null);

  // Footer buttons
  btnNewDay.addEventListener("click", newDay);
  btnRoulette.addEventListener("click", roulette);
  btnDego.addEventListener("click", degoOne);
  btnDone.addEventListener("click", ()=> state.focusId ? finishTask(state.focusId) : showToast("Pas de cible.", 1500));
  btnSkip.addEventListener("click", skip);

  btnNotesTask.addEventListener("click", ()=> openDrawer("notes"));
  btnNotesDay.addEventListener("click", ()=> openDrawer("notes"));

  // Undo/redo
  btnUndo.addEventListener("click", undo);
  btnRedo.addEventListener("click", redo);

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    const key = e.key.toLowerCase();
    if(key==="m"){ openDrawer(state.ui.activeTab); }
    if(key==="r"){ roulette(); }
    if(key==="d"){ degoOne(); }
    if(key==="escape"){ closeDrawer(); }
  });

  // =========================
  // Toast + simple flash
  // =========================
  let toastTimer = null;
  function showToast(msg, ms=2000){
    toast.textContent = String(msg||"");
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
  }

  function resizeFx(){
    fxCanvas.width = Math.floor(window.innerWidth * (window.devicePixelRatio||1));
    fxCanvas.height = Math.floor(window.innerHeight * (window.devicePixelRatio||1));
  }
  window.addEventListener("resize", resizeFx);
  resizeFx();

  function flash(alpha=0.10){
    const w = fxCanvas.width, h = fxCanvas.height;
    fx.clearRect(0,0,w,h);
    fx.globalAlpha = alpha;
    fx.fillStyle = "#ffffff";
    fx.fillRect(0,0,w,h);
    fx.globalAlpha = 1;
    setTimeout(()=>fx.clearRect(0,0,w,h), 60);
  }

  // =========================
  // Boot
  // =========================
  function boot(){
    setFloat(pick(FLOAT_IDLE));
    renderAll();
    showToast("ELIMINATOR chargé.", 1400);
    logEvent("Boot");
    save();
  }

  boot();
})();
</script>
</body>
</html>
